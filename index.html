<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒë‹´ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap');
        * { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto"></div>

    <script>
        // NOTE: Google Apps Script URL. Ensure this script is deployed as a Web App with 'Execute as: Me' and 'Who has access: Anyone'.
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz4outwkBQWipLnWFBv0D_KfvEzRunxJRTQmQshSroYRhrmFHugec_dL_t9abO1wJikkQ/exec';
        
        let state = {
            availableSlots: [],
            bookings: [],
            showSlotForm: false,
            showBookingForm: false,
            editingSlot: null,
            currentDate: new Date(),
            selectedDate: null,
            loading: false,
            syncing: false,
            slotForm: {
                date: '',
                startTime: '',
                endTime: '',
                room: ''
            },
            bookingForm: {
                studentName: '',
                school: '',
                grade: 'elementary',
                hasLevelTest: false,
                date: '',
                time: '', // This is the consultation START time
                room: ''
            },
            // Custom Message/Confirmation Modal State
            message: {
                show: false,
                text: '',
                isConfirm: false,
                confirmAction: null,
                errorDetails: null // Added for detailed error messages
            }
        };

        const gradeLabels = {
            elementary: 'ì´ˆë“±',
            middle: 'ì¤‘ë“±',
            high: 'ê³ ë“±'
        };

        // --- Utility Functions ---

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        function timeToMins(time) {
            const parts = time.split(':');
            const h = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10);
            return h * 60 + m;
        }

        function minsToTime(mins) {
            const totalMins = (mins % (24 * 60) + (24 * 60)) % (24 * 60); // Ensure positive and within 24h
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
        }

        function addMinutesToTime(time, minutes) {
            const totalMins = timeToMins(time) + minutes;
            return minsToTime(totalMins);
        }
        
        function generateTimeOptions(interval = 5) {
            const options = [];
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += interval) {
                    const time = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
                    options.push(time);
                }
            }
            return options;
        }

        // --- Message Box Functions (Replacing alert/confirm) ---

        function showMessage(text, errorDetails = null) {
            state.message = { show: true, text: text, isConfirm: false, confirmAction: null, errorDetails: errorDetails };
            render();
        }

        function showConfirm(text, action) {
            state.message = { show: true, text: text, isConfirm: true, confirmAction: action, errorDetails: null };
            render();
        }

        function closeMessage() {
            state.message.show = false;
            state.message.confirmAction = null;
            state.message.errorDetails = null;
            render();
        }

        function executeConfirmAction() {
            if (state.message.confirmAction) {
                state.message.confirmAction();
            }
            closeMessage();
        }

        // --- Google Sheets API Functions ---

        async function loadFromGoogleSheets() {
            state.loading = true;
            render();
            
            try {
                const today = formatDate(new Date());
                
                // Fetch Slots
                let slotsData = [];
                try {
                    const slotsResponse = await fetch(GOOGLE_SCRIPT_URL + '?sheet=slots');
                    if (!slotsResponse.ok) {
                        throw new Error(`HTTP Error: ${slotsResponse.status} ${slotsResponse.statusText}`);
                    }
                    slotsData = await slotsResponse.json();
                } catch (e) {
                    throw new Error(`ìŠ¬ë¡¯ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
                }
                state.availableSlots = slotsData.filter(slot => slot.date >= today && slot.id);
                
                // Fetch Bookings
                let bookingsData = [];
                try {
                    const bookingsResponse = await fetch(GOOGLE_SCRIPT_URL + '?sheet=bookings');
                    if (!bookingsResponse.ok) {
                        throw new Error(`HTTP Error: ${bookingsResponse.status} ${bookingsResponse.statusText}`);
                    }
                    bookingsData = await bookingsResponse.json();
                } catch (e) {
                    throw new Error(`ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
                }
                state.bookings = bookingsData.filter(booking => booking.date >= today && booking.id);
                
                console.log('ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                
                // ----------------------------------------------------
                // âœ¨ ê¶Œí•œ ë° CORS ë¬¸ì œì— ëŒ€í•œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                // ----------------------------------------------------
                const genericErrorText = 'ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ ì£¼ì„¸ìš”:';
                const troubleshootingSteps = `
                    1. **Google Apps Script ì¬ë°°í¬:** ìŠ¤í¬ë¦½íŠ¸ í¸ì§‘ê¸°ì—ì„œ 'ë°°í¬' > 'ë°°í¬ ê´€ë¦¬'ë¡œ ì´ë™í•©ë‹ˆë‹¤.
                    2. **ì•¡ì„¸ìŠ¤ ê¶Œí•œ í™•ì¸:** 'ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì(Who has access)'ê°€ **'ëª¨ë“  ì‚¬ìš©ì(Anyone)'**ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë‹¤ì‹œ ë°°í¬í•˜ì„¸ìš”.
                    3. **URL ì¼ì¹˜:** ìŠ¤í¬ë¦½íŠ¸ URLì´ ì½”ë“œì— ì…ë ¥ëœ URLê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
                `;
                
                showMessage(genericErrorText, troubleshootingSteps);
            } finally {
                state.loading = false;
                render();
            }
        }

        async function addToGoogleSheets(sheet, data) {
            const formData = new FormData();
            formData.append('sheet', sheet);
            formData.append('action', 'add');
            formData.append('data', JSON.stringify(data));
            
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
             if (!response.ok) {
                throw new Error(`HTTP Error during add: ${response.status} ${response.statusText}`);
            }
            return response;
        }

        async function deleteFromGoogleSheets(sheet, id) {
            const formData = new FormData();
            formData.append('sheet', sheet);
            formData.append('action', 'delete');
            formData.append('id', id);
            
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
             if (!response.ok) {
                throw new Error(`HTTP Error during delete: ${response.status} ${response.statusText}`);
            }
            return response;
        }

        // --- Slot Management ---

        async function addSlot() {
            if (!state.slotForm.date || !state.slotForm.startTime || !state.slotForm.endTime || !state.slotForm.room) {
                showMessage('ë‚ ì§œ, ì‹œì‘ ì‹œê°„, ì¢…ë£Œ ì‹œê°„, ê°•ì˜ì‹¤ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const startMins = timeToMins(state.slotForm.startTime);
            const endMins = timeToMins(state.slotForm.endTime);

            if (startMins >= endMins) {
                 showMessage('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.');
                 return;
            }
            
            state.syncing = true;
            render();
            
            try {
                const newSlot = {
                    id: Date.now().toString(),
                    date: state.slotForm.date,
                    startTime: state.slotForm.startTime,
                    endTime: state.slotForm.endTime,
                    room: state.slotForm.room
                };
                await addToGoogleSheets('slots', newSlot);
                // ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì „ì²´ ëª©ë¡ì„ ë‹¤ì‹œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                await loadFromGoogleSheets(); 
                
                // Reset form and UI state
                state.slotForm = { date: '', startTime: '', endTime: '', room: '' };
                state.showSlotForm = false;
                showMessage('ê°€ëŠ¥ ì‹œê°„ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ì—ëŸ¬:', error);
                showMessage('ê°€ëŠ¥ ì‹œê°„ ì €ì¥ ì‹¤íŒ¨! Google Sheets ìŠ¤í¬ë¦½íŠ¸ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', error.message);
            } finally {
                state.syncing = false;
                render();
            }
        }

        async function deleteSlot(id) {
            showConfirm('ì •ë§ ìƒë‹´ ê°€ëŠ¥ ì‹œê°„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‹œê°„ëŒ€ì— ì˜ˆì•½ëœ ìƒë‹´ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.', async () => {
                state.syncing = true;
                render();
                
                try {
                    await deleteFromGoogleSheets('slots', id);
                    // ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì „ì²´ ëª©ë¡ì„ ë‹¤ì‹œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    await loadFromGoogleSheets(); 
                    showMessage('ê°€ëŠ¥ ì‹œê°„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                } catch (error) {
                    showMessage('ì‚­ì œ ì‹¤íŒ¨!');
                } finally {
                    state.syncing = false;
                    render();
                }
            });
        }

        // --- Booking Management (Core Logic Update) ---

        async function addBooking() {
            const bookingForm = state.bookingForm;
            if (!bookingForm.studentName || !bookingForm.date || !bookingForm.time || !bookingForm.room) {
                showMessage('í•™ìƒ ì´ë¦„, ë‚ ì§œ, ì‹œê°„, ê°•ì˜ì‹¤ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            let levelTestMins = 0;
            if (bookingForm.hasLevelTest) {
                levelTestMins = bookingForm.grade === 'elementary' ? 40 : 50;
            }
            
            const totalDurationMins = levelTestMins + 30; // Consultation is always 30 mins
            
            // --- 1. Total Duration Check (Point 2) ---
            if (totalDurationMins > 120) { // Safety check, assuming max 2 hours
                 showMessage('ìƒë‹´ ë° í…ŒìŠ¤íŠ¸ ì‹œê°„ì´ ë„ˆë¬´ ê¸¸ì–´ ì˜ˆì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                 return;
            }

            const consultTime = bookingForm.time; // This is the consultation START time
            const bookingStartTime = addMinutesToTime(consultTime, -levelTestMins); // Actual start time (includes test)
            const bookingEndTime = addMinutesToTime(consultTime, 30); // Actual end time (consultation ends)

            const bookingDate = bookingForm.date;
            const bookingRoom = bookingForm.room;
            
            const newStartMins = timeToMins(bookingStartTime);
            const newEndMins = timeToMins(bookingEndTime);

            // --- 2. Check against Available Slots (Points 1 & 2) ---
            const relevantSlots = state.availableSlots.filter(
                s => s.date === bookingDate && s.room === bookingRoom
            );
            
            let slotFits = false;

            for (const slot of relevantSlots) {
                const slotStartMins = timeToMins(slot.startTime);
                const slotEndMins = timeToMins(slot.endTime);
                
                // Check if the NEW booking time window (Start to End) is completely contained within the slot
                if (newStartMins >= slotStartMins && newEndMins <= slotEndMins) {
                    slotFits = true;
                    break;
                }
            }
            
            if (!slotFits) {
                const requiredTimeMsg = bookingForm.hasLevelTest ? 
                    `(ì´ ${totalDurationMins}ë¶„ í•„ìš”)` : `(ì´ 30ë¶„ í•„ìš”)`;
                showMessage(`ì„ íƒí•œ ì‹œê°„ì€ ë“±ë¡ëœ ìƒë‹´ ê°€ëŠ¥ ì‹œê°„ ë²”ìœ„(${requiredTimeMsg})ì— ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. ê°•ì˜ì‹¤ì˜ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ê³¼ ë ˆë²¨í…ŒìŠ¤íŠ¸ ìœ ë¬´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                return;
            }
            
            // --- 3. Check against Existing Bookings (Time Conflict) ---
            const hasConflict = state.bookings.some(booking => {
                if (booking.date !== bookingDate || booking.room !== bookingRoom) return false;
                
                // Note: booking.time and booking.endTime are the actual start/end of the ENTIRE booking (test + consult)
                const existingStartMins = timeToMins(booking.time);
                const existingEndMins = timeToMins(booking.endTime);
                
                // Conflict check (standard overlap logic: A starts before B ends AND A ends after B starts)
                return newStartMins < existingEndMins && newEndMins > existingStartMins;
            });
            
            if (hasConflict) {
                showMessage('ì„ íƒí•œ ì‹œê°„ì— ë‹¤ë¥¸ ì˜ˆì•½ê³¼ ê²¹ì¹©ë‹ˆë‹¤. ë‹¤ë¥¸ ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            state.syncing = true;
            render();
            
            try {
                const newBooking = {
                    id: Date.now().toString(),
                    studentName: bookingForm.studentName,
                    school: bookingForm.school,
                    grade: bookingForm.grade,
                    hasLevelTest: bookingForm.hasLevelTest,
                    date: bookingDate,
                    time: bookingStartTime, // Actual Booking Start Time (Test or Consult)
                    endTime: bookingEndTime, // Actual Booking End Time (Consult End)
                    room: bookingRoom,
                    consultTime: consultTime // Consultation Start Time
                };
                
                await addToGoogleSheets('bookings', newBooking);
                // ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì „ì²´ ëª©ë¡ì„ ë‹¤ì‹œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                await loadFromGoogleSheets(); 
                
                // Reset form (keeping date/room for convenience)
                state.bookingForm = {
                    studentName: '',
                    school: '',
                    grade: bookingForm.grade,
                    hasLevelTest: bookingForm.hasLevelTest,
                    date: bookingDate,
                    time: '',
                    room: bookingRoom
                };
                state.showBookingForm = false;
                showMessage('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ì—ëŸ¬:', error);
                showMessage('ì˜ˆì•½ ë“±ë¡ ì‹¤íŒ¨! Google Sheets ìŠ¤í¬ë¦½íŠ¸ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', error.message);
            } finally {
                state.syncing = false;
                render();
            }
        }

        async function deleteBooking(id) {
            showConfirm('ì •ë§ ì´ ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
                state.syncing = true;
                render();
                
                try {
                    await deleteFromGoogleSheets('bookings', id);
                    // ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì „ì²´ ëª©ë¡ì„ ë‹¤ì‹œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    await loadFromGoogleSheets(); 
                    showMessage('ì˜ˆì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                } catch (error) {
                    showMessage('ì‚­ì œ ì‹¤íŒ¨!');
                } finally {
                    state.syncing = false;
                    render();
                }
            });
        }

        // --- Calendar Navigation ---

        function handleDateClick(dateStr, isPast) {
            if (isPast) return;
            state.selectedDate = dateStr;
            // Also update the date in the booking form when selecting from calendar
            state.bookingForm.date = dateStr;
            state.bookingForm.room = ''; // Reset room/time as available rooms might change
            state.bookingForm.time = '';
            render();
        }

        function prevMonth() {
            state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() - 1);
            render();
        }

        function nextMonth() {
            state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1);
            render();
        }

        // --- Render Functions ---
        
        function renderCalendar() {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            const today = formatDate(new Date());
            
            let html = '';
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="h-16 md:h-20"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDate(date);
                const hasSlots = state.availableSlots.some(slot => slot.date === dateStr);
                const hasBooking = state.bookings.some(booking => booking.date === dateStr);
                const isSelected = state.selectedDate === dateStr;
                const isToday = dateStr === today;
                const isPast = dateStr < today;
                
                let classes = 'h-16 md:h-20 border rounded-lg p-2 transition shadow-sm text-sm ';
                if (isPast) {
                    classes += 'bg-gray-100 cursor-not-allowed opacity-50';
                } else if (isSelected) {
                    classes += 'bg-indigo-100 border-indigo-500 ring-2 ring-indigo-500 cursor-pointer scale-[1.03]';
                } else if (hasSlots || hasBooking) {
                    classes += 'bg-white hover:bg-green-50 cursor-pointer border-green-300';
                } else {
                    classes += 'bg-white hover:bg-gray-50 cursor-pointer';
                }
                if (isToday) classes += ' ring-2 ring-offset-2 ring-blue-400';
                
                html += '<div class="' + classes + '" onclick="handleDateClick(\'' + dateStr + '\', ' + isPast + ')">';
                html += '<div class="font-bold ' + (isPast ? 'text-gray-400' : 'text-gray-800') + '">' + day + '</div>';
                html += '<div class="flex gap-1 mt-1">';
                if (hasSlots && !isPast) {
                    html += '<div class="w-3 h-3 bg-green-500 rounded-full" title="ìƒë‹´ ê°€ëŠ¥"></div>';
                }
                if (hasBooking && !isPast) {
                    html += '<div class="w-3 h-3 bg-blue-500 rounded-full" title="ì˜ˆì•½ ìˆìŒ"></div>';
                }
                html += '</div></div>';
            }
            
            return html;
        }

        function renderMessageBox() {
            if (!state.message.show) return '';
            
            const { text, isConfirm, errorDetails } = state.message;
            
            return `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100">
                        <div class="text-xl font-bold mb-4 ${errorDetails ? 'text-red-600' : 'text-gray-800'}">
                            ${isConfirm ? 'í™•ì¸ í•„ìš”' : (errorDetails ? 'âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œ ì˜ˆìƒ)' : 'ì•Œë¦¼')}
                        </div>
                        <p class="text-gray-700 mb-6">${text}</p>
                        ${errorDetails ? `
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200 mb-6">
                                <h5 class="font-bold text-red-700 mb-2">Google Script ì„¤ì • í™•ì¸:</h5>
                                <pre class="text-sm text-red-700 whitespace-pre-wrap">${errorDetails}</pre>
                            </div>
                        ` : ''}
                        <div class="flex justify-end space-x-3">
                            ${isConfirm ? `
                                <button onclick="closeMessage()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-medium">ì·¨ì†Œ</button>
                                <button onclick="executeConfirmAction()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium">í™•ì¸</button>
                            ` : `
                                <button onclick="closeMessage()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition font-medium">ë‹«ê¸°</button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
            const selectedSlots = state.availableSlots.filter(s => s.date === state.selectedDate).sort((a, b) => a.startTime.localeCompare(b.startTime));
            const selectedBookings = state.bookings.filter(b => b.date === state.selectedDate).sort((a, b) => a.time.localeCompare(b.time));
            const availableRooms = [...new Set(state.availableSlots.filter(s => s.date === state.bookingForm.date).map(s => s.room))];
            
            let html = '<div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8">';
            
            // --- Header ---
            html += '<div class="flex justify-between items-center mb-8 border-b pb-4">';
            html += '<h1 class="text-3xl font-extrabold text-gray-800">ğŸ“… ìƒë‹´ ì˜ˆì•½ ì‹œìŠ¤í…œ</h1>';
            html += '<button onclick="loadFromGoogleSheets()" ' + (state.loading || state.syncing ? 'disabled' : '') + ' class="bg-green-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-md hover:bg-green-600 transition disabled:opacity-50">';
            html += 'ğŸ”„ ' + (state.loading ? 'ë¡œë”©ì¤‘...' : state.syncing ? 'ë™ê¸°í™”ì¤‘...' : 'ìƒˆë¡œê³ ì¹¨');
            html += '</button></div>';

            // --- Loading State ---
            if (state.loading) {
                html += '<div class="text-center py-20">';
                html += '<div class="inline-block animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600"></div>';
                html += '<p class="mt-4 text-gray-600 font-medium">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
                html += '</div>';
            } else if (state.message.errorDetails && !state.availableSlots.length && !state.bookings.length) {
                 // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ, ë‹¬ë ¥ ëŒ€ì‹  ê²½ê³  ë©”ì‹œì§€ë§Œ í‘œì‹œ
                 html += '<div class="text-center py-20">';
                 html += '<p class="text-2xl font-bold text-red-600">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨!</p>';
                 html += '<p class="mt-4 text-gray-600">Google Apps Scriptì˜ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
                 html += '</div>';
            } else {
                
                // --- Calendar Section ---
                html += '<div class="mb-10">';
                html += '<div class="flex flex-col sm:flex-row justify-between items-center mb-6">';
                html += '<h2 class="text-2xl font-bold text-gray-700">ìº˜ë¦°ë”</h2>';
                html += '<div class="flex items-center gap-2 mt-4 sm:mt-0">';
                html += '<button onclick="prevMonth()" class="p-2 w-10 h-10 flex items-center justify-center text-indigo-600 hover:bg-indigo-50 rounded-full transition text-lg font-bold">ã€ˆ</button>';
                html += '<span class="text-xl font-bold text-gray-800 w-32 text-center">' + state.currentDate.getFullYear() + 'ë…„ ' + monthNames[state.currentDate.getMonth()] + '</span>';
                html += '<button onclick="nextMonth()" class="p-2 w-10 h-10 flex items-center justify-center text-indigo-600 hover:bg-indigo-50 rounded-full transition text-lg font-bold">ã€‰</button>';
                html += '</div></div>';
                
                html += '<div class="mb-4 flex flex-wrap gap-4 text-sm text-gray-600">';
                html += '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-green-500 rounded-full"></div><span class="font-medium">ìƒë‹´ ê°€ëŠ¥</span></div>';
                html += '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-blue-500 rounded-full"></div><span class="font-medium">ì˜ˆì•½ ìˆìŒ</span></div>';
                html += '</div>';

                html += '<div class="grid grid-cols-7 gap-1.5 md:gap-2">';
                const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                for (let i = 0; i < days.length; i++) {
                    html += '<div class="text-center font-bold text-sm md:text-base p-2 rounded-lg ' + (i === 0 ? 'text-red-500' : 'text-gray-600') + '">' + days[i] + '</div>';
                }
                html += '</div>';
                
                html += '<div class="grid grid-cols-7 gap-1.5 md:gap-2">';
                html += renderCalendar();
                html += '</div></div>';

                // --- Selected Date Details and Slot Form ---
                if (state.selectedDate) {
                    html += '<div class="border-t pt-8 mb-10">';
                    html += '<div class="flex justify-between items-center mb-6">';
                    html += '<h3 class="text-2xl font-bold text-gray-800">' + state.selectedDate + ' ìƒì„¸ ì •ë³´</h3>';
                    html += '<button onclick="state.slotForm.date = \'' + state.selectedDate + '\'; state.showSlotForm = !state.showSlotForm; render();" class="bg-pink-500 text-white px-3 py-1.5 rounded-xl text-sm font-medium hover:bg-pink-600 transition shadow-md">';
                    html += (state.showSlotForm ? 'ì·¨ì†Œ' : '+ ê°€ëŠ¥ ì‹œê°„ ì¶”ê°€');
                    html += '</button>';
                    html += '</div>';

                    // --- Slot Form (Point 3 Fix) ---
                    if (state.showSlotForm) {
                        const timeOptions = generateTimeOptions(5);
                        html += '<div class="mb-8 bg-pink-50 p-5 rounded-xl border-2 border-pink-300 shadow-inner">';
                        html += '<h4 class="font-bold text-pink-700 mb-4">ìƒˆë¡œìš´ ìƒë‹´ ê°€ëŠ¥ ì‹œê°„ ë“±ë¡</h4>';
                        html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">';
                        
                        // Date Input
                        html += '<input type="date" value="' + state.slotForm.date + '" onchange="state.slotForm.date = this.value; render();" class="border rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500" />';
                        
                        // Start Time SELECT (Fixed)
                        html += '<select onchange="state.slotForm.startTime = this.value;" class="border rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">';
                        html += '<option value="">ì‹œì‘ ì‹œê°„</option>';
                        for (let i = 0; i < timeOptions.length; i++) {
                            const selected = timeOptions[i] === state.slotForm.startTime ? 'selected' : '';
                            html += '<option value="' + timeOptions[i] + '" ' + selected + '>' + timeOptions[i] + '</option>';
                        }
                        html += '</select>';
                        
                        // End Time SELECT (Fixed)
                        html += '<select onchange="state.slotForm.endTime = this.value;" class="border rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">';
                        html += '<option value="">ì¢…ë£Œ ì‹œê°„</option>';
                        for (let i = 0; i < timeOptions.length; i++) {
                            const selected = timeOptions[i] === state.slotForm.endTime ? 'selected' : '';
                            html += '<option value="' + timeOptions[i] + '" ' + selected + '>' + timeOptions[i] + '</option>';
                        }
                        html += '</select>';

                        // Room Input
                        html += '<input type="text" value="' + state.slotForm.room + '" oninput="state.slotForm.room = this.value;" placeholder="ê°•ì˜ì‹¤ (ì˜ˆ: 2ê´€)" class="border rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500" />';
                        html += '</div><div class="flex gap-2">';
                        
                        // Buttons
                        html += '<button onclick="addSlot()" ' + (state.syncing ? 'disabled' : '') + ' class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600 transition disabled:opacity-50 font-medium shadow-md">';
                        html += (state.syncing ? 'ì €ì¥ì¤‘...' : 'ë“±ë¡') + '</button>';
                        html += '</div></div>';
                    }

                    // --- Available Slots List ---
                    html += '<div><h4 class="font-semibold text-gray-800 mb-3 border-l-4 border-green-500 pl-3">ìƒë‹´ ê°€ëŠ¥ ì‹œê°„ ëª©ë¡ (' + selectedSlots.length + 'ê±´)</h4>';
                    html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">';
                    
                    if (selectedSlots.length === 0) {
                        html += '<p class="text-gray-500 text-sm p-3 bg-gray-50 rounded-lg">ë“±ë¡ëœ ê°€ëŠ¥ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì— + ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
                    } else {
                        for (let i = 0; i < selectedSlots.length; i++) {
                            const slot = selectedSlots[i];
                            html += '<div class="bg-green-50 p-3 rounded-xl border border-green-300 shadow-sm">';
                            html += '<div class="flex justify-between items-start">';
                            html += '<div><div class="font-bold text-green-800">' + slot.room + '</div>';
                            html += '<div class="text-sm text-gray-700 font-mono">' + slot.startTime + ' - ' + slot.endTime + '</div></div>';
                            html += '<button onclick="deleteSlot(\'' + slot.id + '\')" class="text-red-500 hover:text-red-700 text-sm p-1 transition">ì‚­ì œ</button>';
                            html += '</div></div>';
                        }
                    }
                    html += '</div></div>'; // End Slot List

                    // --- Bookings List ---
                    html += '<div class="mt-8"><h4 class="font-semibold text-gray-800 mb-3 border-l-4 border-blue-500 pl-3">ì˜ˆì•½ í˜„í™© ëª©ë¡ (' + selectedBookings.length + 'ê±´)</h4>';
                    html += '<div class="space-y-3">';
                    
                    if (selectedBookings.length === 0) {
                        html += '<p class="text-gray-500 text-sm p-3 bg-gray-50 rounded-lg">ì˜ˆì•½ëœ ìƒë‹´ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    } else {
                        for (let i = 0; i < selectedBookings.length; i++) {
                            const booking = selectedBookings[i];
                            html += '<div class="bg-blue-50 p-4 rounded-xl border border-blue-300 shadow-sm">';
                            html += '<div class="flex justify-between items-start">';
                            html += '<div class="flex-1">';
                            html += '<div class="text-md font-bold text-blue-800 mb-1 flex items-center gap-2">';
                            html += '<span>' + booking.studentName + '</span><span class="text-sm font-normal text-gray-600">(' + booking.school + ' ' + gradeLabels[booking.grade] + ')</span>';
                            html += '</div>';
                            html += '<div class="text-sm text-gray-700">';
                            html += '<span class="font-mono bg-blue-100 px-1 rounded">' + booking.time + ' - ' + booking.endTime + '</span>';
                            html += '<span class="text-gray-500 mx-2">|</span>';
                            html += '<span class="font-semibold text-indigo-700">' + booking.room + '</span>';
                            html += '<span class="text-gray-500 mx-2">|</span>';
                            html += '<span class="text-green-700 font-medium">' + (booking.hasLevelTest ? 'ë ˆë²¨í…ŒìŠ¤íŠ¸ + ìƒë‹´' : 'ìƒë‹´') + '</span>';
                            html += '</div>';
                            if (booking.hasLevelTest) {
                                html += '<p class="text-xs text-gray-500 mt-1">ìƒë‹´ ì‹œì‘ ì‹œê°„: ' + booking.consultTime + '</p>';
                            }
                            html += '</div><button onclick="deleteBooking(\'' + booking.id + '\')" class="text-red-500 hover:text-red-700 ml-2">ğŸ—‘ï¸</button>';
                            html += '</div></div>';
                        }
                    }
                    html += '</div></div>'; // End Booking List
                    html += '</div>'; // End Selected Date Details
                }


                // --- Reservation Form ---
                html += '<div class="border-t pt-8">';
                html += '<div class="flex justify-between items-center mb-6">';
                html += '<h2 class="text-2xl font-bold text-gray-700">ì‹ ê·œ ì˜ˆì•½ ë“±ë¡</h2>';
                html += '<button onclick="state.showBookingForm = !state.showBookingForm; render();" class="bg-indigo-500 text-white px-4 py-2 rounded-xl font-medium hover:bg-indigo-600 shadow-md transition">';
                html += (state.showBookingForm ? 'ì·¨ì†Œ' : '+ ì˜ˆì•½ ì¶”ê°€');
                html += '</button>';
                html += '</div>';

                if (state.showBookingForm) {
                    const timeOptions = generateTimeOptions(5);
                    html += '<div class="bg-gray-50 p-5 rounded-xl mb-4 border-2 border-indigo-300 shadow-inner">';
                    html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">';
                    
                    // Row 1: Student Details
                    html += '<input type="text" value="' + state.bookingForm.studentName + '" oninput="state.bookingForm.studentName = this.value" placeholder="í•™ìƒ ì´ë¦„" class="border rounded-lg px-3 py-2" />';
                    html += '<input type="text" value="' + state.bookingForm.school + '" oninput="state.bookingForm.school = this.value" placeholder="í•™êµëª…" class="border rounded-lg px-3 py-2" />';
                    html += '<select onchange="state.bookingForm.grade = this.value; render();" class="border rounded-lg px-3 py-2"><option value="elementary" ' + (state.bookingForm.grade === 'elementary' ? 'selected' : '') + '>ì´ˆë“±í•™ìƒ</option><option value="middle" ' + (state.bookingForm.grade === 'middle' ? 'selected' : '') + '>ì¤‘í•™ìƒ</option><option value="high" ' + (state.bookingForm.grade === 'high' ? 'selected' : '') + '>ê³ ë“±í•™ìƒ</option></select>';
                    html += '<label class="flex items-center gap-2 border rounded-lg px-3 py-2 bg-white cursor-pointer hover:bg-gray-100">';
                    html += '<input type="checkbox" ' + (state.bookingForm.hasLevelTest ? 'checked' : '') + ' onchange="state.bookingForm.hasLevelTest = this.checked; render();" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />ë ˆë²¨í…ŒìŠ¤íŠ¸</label>';
                    
                    // Row 2: Booking Details
                    html += '<input type="date" value="' + state.bookingForm.date + '" onchange="state.bookingForm.date = this.value; state.bookingForm.room = \'\'; state.bookingForm.time = \'\'; state.selectedDate = this.value; render();" class="border rounded-lg px-3 py-2" />';
                    
                    // Room Select
                    html += '<select onchange="state.bookingForm.room = this.value; state.bookingForm.time = \'\'; render();" class="border rounded-lg px-3 py-2" ' + (!state.bookingForm.date ? 'disabled' : '') + '>';
                    html += '<option value="">ê°•ì˜ì‹¤ ì„ íƒ</option>';
                    for (let i = 0; i < availableRooms.length; i++) {
                        const selected = availableRooms[i] === state.bookingForm.room ? 'selected' : '';
                        html += '<option value="' + availableRooms[i] + '" ' + selected + '>' + availableRooms[i] + '</option>';
                    }
                    html += '</select>';
                    
                    // Time Select
                    html += '<select onchange="state.bookingForm.time = this.value" class="border rounded-lg px-3 py-2" ' + (!state.bookingForm.room ? 'disabled' : '') + '>';
                    html += '<option value="">ìƒë‹´ ì‹œì‘ ì‹œê°„ (30ë¶„)</option>';
                    for (let i = 0; i < timeOptions.length; i++) {
                        const selected = timeOptions[i] === state.bookingForm.time ? 'selected' : '';
                        html += '<option value="' + timeOptions[i] + '" ' + selected + '>' + timeOptions[i] + '</option>';
                    }
                    html += '</select>';
                    
                    html += '<div class="text-sm text-gray-600 flex items-center justify-start py-2">';
                    html += 'ì´ ì†Œìš” ì‹œê°„: <span class="font-bold text-indigo-700 ml-1">';
                    const currentTestMins = state.bookingForm.hasLevelTest ? (state.bookingForm.grade === 'elementary' ? 40 : 50) : 0;
                    html += `${currentTestMins + 30}ë¶„`;
                    html += '</span></div>';
                    
                    html += '</div><div class="flex gap-2">';
                    html += '<button onclick="addBooking()" ' + (state.syncing ? 'disabled' : '') + ' class="bg-indigo-500 text-white px-6 py-2 rounded-xl font-medium hover:bg-indigo-600 disabled:opacity-50 shadow-md">';
                    html += (state.syncing ? 'ì €ì¥ì¤‘...' : 'ì˜ˆì•½ ì¶”ê°€') + '</button>';
                    html += '</div></div>';
                }

                // --- Global Booking List ---
                html += '<div class="mt-8"><h3 class="text-xl font-bold text-gray-700 mb-4">ì „ì²´ ì˜ˆì•½ ëª©ë¡</h3>';
                html += '<div class="space-y-3">';
                
                const sortedBookings = state.bookings.sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.time.localeCompare(b.time);
                });
                
                if (sortedBookings.length === 0) {
                     html += '<p class="text-gray-500 text-sm p-3 bg-gray-50 rounded-lg">ë“±ë¡ëœ í–¥í›„ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    for (let i = 0; i < sortedBookings.length; i++) {
                        const booking = sortedBookings[i];
                        html += '<div class="bg-white border-2 border-gray-200 p-4 rounded-xl hover:shadow-lg transition">';
                        html += '<div class="flex justify-between items-center"><div class="flex-1">';
                        html += '<div class="text-lg font-semibold text-gray-800 mb-1">';
                        html += booking.date + ' / ' + booking.room + ' / ' + booking.studentName;
                        html += '</div><div class="flex items-center gap-4 text-gray-600 text-sm">';
                        html += '<span>ğŸ• ' + booking.time + ' - ' + booking.endTime + '</span>';
                        html += '<span class="font-medium text-indigo-600">' + (booking.hasLevelTest ? 'ë ˆë²¨í…ŒìŠ¤íŠ¸ + ìƒë‹´' : 'ìƒë‹´') + '</span>';
                        html += '</div>';
                        if (booking.hasLevelTest) {
                             html += '<p class="text-xs text-gray-500 mt-1">ìƒë‹´ ì‹œì‘: ' + booking.consultTime + ' / í•™êµ: ' + booking.school + '</p>';
                        }
                        html += '</div><button onclick="deleteBooking(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="text-red-500 hover:text-red-700 disabled:opacity-50 p-2">ğŸ—‘ï¸</button>';
                        html += '</div></div>';
                    }
                }
                html += '</div></div>';
                html += '</div>'; // End App Content
            }

            html += '</div>'; // End App container

            // Append the custom message box UI
            html += renderMessageBox();

            document.getElementById('app').innerHTML = html;
        }

        window.onload = function() {
            loadFromGoogleSheets();
        };
    </script>
</body>
</html>



