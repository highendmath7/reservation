<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ìƒë‹´ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
    * { font-family: 'Noto Sans KR', sans-serif; }
    .calendar-grid > div { text-align: center; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4 md:p-8">
  <div id="app" class="max-w-7xl mx-auto"></div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxDW-uVHGSJVQsP9xUtxGA4AzKESeJ-MbuBtV-jy8-8HJ6lqQZVlc4ukkMLvEb4wqw7-g/exec';
    
    let msgState = {
        show: false,
        type: 'alert',
        message: '',
        confirmCallback: null
    };

    function showCustomAlert(message) {
        msgState = { show: true, type: 'alert', message: message, confirmCallback: null };
        render();
    }

    function showCustomConfirm(message, callback) {
        msgState = { show: true, type: 'confirm', message: message, confirmCallback: callback };
        render();
    }

    function closeMessageBox() {
        msgState = { show: false, type: 'alert', message: '', confirmCallback: null };
        render();
    }

    function executeConfirm(result) {
        const callback = msgState.confirmCallback;
        closeMessageBox();
        if (result && callback) callback();
    }

    let state = {
      editingBooking: null,
      availableSlots: [],
      bookings: [],
      showSlotForm: false,
      showBookingForm: false,
      showHistoryModal: false,
      showReasonModal: false,
      editingSlot: null,
      currentDate: new Date(),
      selectedDate: null,
      loading: false,
      syncing: false,
      selectedBookingId: null,
      cancelReason: '',
      cancelReasonType: '',
      slotForm: { date: '', startTime: '', endTime: '', room: '', teacher: '', testStartTime: '' }, // âœ¨ 2ê°œ í•„ë“œ ì¶”ê°€
      bookingForm: {
          studentName: '',
          school: '',
          grade: 'elementary1',
          hasLevelTest: false,
          date: '',
          time: '',
          room: '',
          consultMode: 'in_person',
          testRoom: ''
      }
    };

    const gradeLabels = {
      elementary: 'ì´ˆë“±',
      middle: 'ì¤‘ë“±',
      high: 'ê³ ë“±',
      elementary1: 'ì´ˆ1',
      elementary2: 'ì´ˆ2',
      elementary3: 'ì´ˆ3',
      elementary4: 'ì´ˆ4',
      elementary5: 'ì´ˆ5',
      elementary6: 'ì´ˆ6',
      middle1: 'ì¤‘1',
      middle2: 'ì¤‘2',
      middle3: 'ì¤‘3',
      high1: 'ê³ 1',
      high2: 'ê³ 2',
      high3: 'ê³ 3',
      unknown: 'ëª¨ë¦„'
    };

    // ìš´ì˜ì‹œê°„ ì„¤ì •
    const centerHours = {
      '2ê´€': { weekday: ['15:00','22:00'], weekend: ['10:00','21:00'] },
      '5ê´€': { weekday: ['15:00','22:00'], weekend: ['10:00','21:00'] }
    };

    // ê³ ì • ì¼ì • í…œí”Œë¦¿
      const fixedSchedule = {
      1: [ // ì›”ìš”ì¼
        { room: 'í•˜ì•ˆê´€', startTime: '15:10', endTime: '16:30', teacher: 'ë°•ë‚˜ì˜', testStartTime: '15:05' },
        { room: 'í•˜ì•ˆê´€', startTime: '20:00', endTime: '22:00', teacher: 'ë°•ë‚˜ì˜', testStartTime: '19:10' },
        { room: 'ì² ì‚°ê´€', startTime: '15:30', endTime: '16:10', teacher: 'ì²¨ì‚­T', testStartTime: '15:05' },
        { room: 'ì² ì‚°ê´€', startTime: '20:30', endTime: '22:00', teacher: 'ì²¨ì‚­T', testStartTime: '19:40' }
      ],
      2: [ // í™”ìš”ì¼
        { room: 'ì² ì‚°ê´€', startTime: '15:10', endTime: '21:00', teacher: 'í•œìŠ¹ë¯¼', testStartTime: '15:05' }
      ],
      3: [ // ìˆ˜ìš”ì¼
        { room: 'í•˜ì•ˆê´€', startTime: '15:10', endTime: '18:00', teacher: 'ë°•ë‚˜ì˜', testStartTime: '15:05' },
        { room: 'ì² ì‚°ê´€', startTime: '15:30', endTime: '17:30', teacher: 'ì²¨ì‚­T', testStartTime: '15:05' }
      ],
      4: [ // ëª©ìš”ì¼
        { room: 'ì² ì‚°ê´€', startTime: '15:10', endTime: '21:00', teacher: 'í•œìŠ¹ë¯¼', testStartTime: '15:05' }
      ],
      5: [ // ê¸ˆìš”ì¼
        { room: 'í•˜ì•ˆê´€', startTime: '15:10', endTime: '16:30', teacher: 'ë°•ë‚˜ì˜', testStartTime: '15:05' },
        { room: 'í•˜ì•ˆê´€', startTime: '18:00', endTime: '20:00', teacher: 'ë°•ë‚˜ì˜', testStartTime: '17:10' },
        { room: 'ì² ì‚°ê´€', startTime: '15:30', endTime: '16:10', teacher: 'ê¹€ë™ë¯¼', testStartTime: '15:05' },
        { room: 'ì² ì‚°ê´€', startTime: '18:30', endTime: '19:30', teacher: 'ì²¨ì‚­T', testStartTime: '17:40' }
      ],
      6: [ // í† ìš”ì¼
        { room: 'í•˜ì•ˆê´€', startTime: '10:10', endTime: '13:00', teacher: 'í•œìŠ¹ë¯¼', testStartTime: '10:05' },
        { room: 'í•˜ì•ˆê´€', startTime: '13:00', endTime: '17:30', teacher: 'í•œìŠ¹ë¯¼', testStartTime: '13:00' },
        { room: 'ì² ì‚°ê´€', startTime: '10:30', endTime: '12:30', teacher: 'ìœ¤ì§€ìœ ', testStartTime: '10:05' }
      ]
    };

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function getOneMonthAgo() {
      const date = new Date();
      date.setMonth(date.getMonth() - 1);
      return formatDate(date);
    }

    function isWeekend(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      const day = d.getDay();
      return day === 0 || day === 6;
    }

    function getOpenWindow(dateStr, hallPrefix) {
      const cfg = centerHours[hallPrefix];
      if (!cfg) return null;
      const key = isWeekend(dateStr) ? 'weekend' : 'weekday';
      const v = cfg[key];
      if (!v || v.length !== 2) return null;
      return [v[0], v[1]];
    }

    function timeToMins(time) {
      if (time == null) return NaN;
      if (time instanceof Date) return time.getHours() * 60 + time.getMinutes();
      const s = String(time);
      const m = s.match(/(\d{1,2}):(\d{2})(?!.*\d)/);
      if (!m) return NaN;
      const h = parseInt(m[1], 10), mm = parseInt(m[2], 10);
      if (!Number.isFinite(h) || !Number.isFinite(mm)) return NaN;
      return h * 60 + mm;
    }

    function minsToTime(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    }

    function addMinutesToTime(time, minutes) {
      return minsToTime(timeToMins(time) + minutes);
    }

    const norm = v => String(v||'').replace(/\s+/g,'').trim();

    async function loadFromGoogleSheets() {
      state.loading = true;
      render();
    
      const oneMonthAgo = getOneMonthAgo();
      const toArray = (x) => Array.isArray(x)
        ? x
        : (Array.isArray(x?.bookings) ? x.bookings
        : (Array.isArray(x?.data) ? x.data : []));
      
      function toISODateStr(s) {
        if (!s) return '';
        if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0, 10);
      
        let m = s.match(/^\s*(\d{4})[.\-/]\s*(\d{1,2})[.\-/]\s*(\d{1,2})/);
        if (m) return `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
      
        m = s.match(/^\s*(\d{1,2})[.\-/]\s*(\d{1,2})[.\-/]\s*(\d{4})/);
        if (m) return `${m[3]}-${String(m[1]).padStart(2,'0')}-${String(m[2]).padStart(2,'0')}`;
      
        const d = new Date(s);
        if (!isNaN(d)) {
          const y = d.getFullYear();
          const m2 = String(d.getMonth()+1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          return `${y}-${m2}-${dd}`;
        }
        return '';
      }
      
      const isRecent = (d) => {
        const iso = toISODateStr(d);
        return iso && iso >= oneMonthAgo;
      };
    
      const normalizeSlot = (s) => ({
        ...s,
        date: toISODateStr((s?.date ?? '').toString().trim()),
        id: s?.id ?? '',
        room: (s?.room || '').replace('5ê´€í…ŒìŠ¤íŠ¸ì‹¤', '5ê´€')
      });
    
      const normalizeBooking = (b) => {
        const rawGrade = (b?.grade ?? '').toString().trim();
        return {
          ...b,
          id: b?.id ?? '',
          date: toISODateStr((b?.date ?? '').toString().trim()),
          time: b?.time ?? b?.startTime ?? '',
          endTime: b?.endTime ?? '',
          room: (b?.room || '').replace('5ê´€í…ŒìŠ¤íŠ¸ì‹¤', '5ê´€'),
          consultTime: b?.consultTime ?? '',
          status: b?.status ?? 'scheduled',
          cancelReason: b?.cancelReason ?? '',
          completedAt: b?.completedAt ?? '',
          grade: rawGrade,
          _isElementary:
            rawGrade.startsWith('elementary') ||
            rawGrade === 'elementary' ||
            ['ì´ˆ','ì´ˆ1','ì´ˆ2','ì´ˆ3','ì´ˆ4','ì´ˆ5','ì´ˆ6'].some(k => rawGrade.includes(k)),
        };
      };
    
      try {
        const slotsResponse = await fetch(`${GOOGLE_SCRIPT_URL}?sheet=slots&ts=${Date.now()}`, {cache: 'no-store'});
        const slotsRaw = await slotsResponse.json();
        const slotsArr = toArray(slotsRaw).map(normalizeSlot);
        state.availableSlots = slotsArr.filter(s => s.id && isRecent(s.date));
    
        const bookingsResponse = await fetch(`${GOOGLE_SCRIPT_URL}?sheet=bookings&ts=${Date.now()}`, {cache: 'no-store'});
        const bookingsRaw = await bookingsResponse.json();
        const bookingsArr = toArray(bookingsRaw).map(normalizeBooking);
        state.bookings = bookingsArr.filter(b => b.id && isRecent(b.date));
    
        state.bookings.sort((a, b) => (a.date + a.time + a.room).localeCompare(b.date + b.time + b.room));
    
        try { await cleanupOldData(oneMonthAgo); } catch (e) { console.warn('cleanupOldData failed:', e); }
      } catch (err) {
        console.error('loadFromGoogleSheets error:', err);
        state.availableSlots = state.availableSlots || [];
        state.bookings = state.bookings || [];
      } finally {
        state.loading = false;
        if (!state.selectedDate) {
          state.selectedDate = formatDate(new Date());
        }
        render();
      }
    }
   
    async function cleanupOldData(cutoffDate) {
      try {
        const oldSlots = (state.availableSlots || []).filter(slot => slot.date < cutoffDate && slot.id);
        const oldBookings = (state.bookings || []).filter(booking => booking.date < cutoffDate && booking.id);
        
        for (let slot of oldSlots) {
          await deleteFromGoogleSheets('slots', slot.id);
        }
        
        for (let booking of oldBookings) {
          await deleteFromGoogleSheets('bookings', booking.id);
        }
        
        if (oldSlots.length > 0 || oldBookings.length > 0) {
          console.log('1ë‹¬ ì´ì „ ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
        }
      } catch (error) {
        console.error('ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨:', error);
      }
    }

    async function addToGoogleSheets(sheet, data) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'add');
      formData.append('data', JSON.stringify(data));
      await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
      await loadFromGoogleSheets();
      handleDateClick(state.selectedDate, false);
    }

    async function updateInGoogleSheets(sheet, id, data) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'update');
      formData.append('id', id);
      formData.append('data', JSON.stringify(data));
      await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
      await loadFromGoogleSheets();
      handleDateClick(state.selectedDate, false);
    }

    async function deleteFromGoogleSheets(sheet, id) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'delete');
      formData.append('id', id);
      await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
      await loadFromGoogleSheets();
      handleDateClick(state.selectedDate, false);
    }

    function openSlotForm(date) {
      state.slotForm.date = date;
      state.slotForm.room = '';              // âœ¨ ë¹ˆ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
      state.slotForm.teacher = '';           // âœ¨ ì¶”ê°€
      state.slotForm.testStartTime = '';     // âœ¨ ì¶”ê°€
      state.showSlotForm = true;
      render();
    }

    async function addSlot() {
      if (!state.slotForm.date || !state.slotForm.startTime || !state.slotForm.endTime || !state.slotForm.room) {
        showCustomAlert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (timeToMins(state.slotForm.startTime) >= timeToMins(state.slotForm.endTime)) {
        showCustomAlert('ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      state.syncing = true;
      render();
      
      try {
        const newSlot = {
          id: Date.now().toString(),
          date: state.slotForm.date,
          startTime: state.slotForm.startTime,
          endTime: state.slotForm.endTime,
          room: state.slotForm.room,
          teacher: state.slotForm.teacher || '',           // âœ¨ ì¶”ê°€
          testStartTime: state.slotForm.testStartTime || '' // âœ¨ ì¶”ê°€
        };
        await addToGoogleSheets('slots', newSlot);
        
        state.slotForm = { date: '', startTime: '', endTime: '', room: '' };
        state.showSlotForm = false;
        showCustomAlert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (error) {
        console.error('ì—ëŸ¬:', error);
        showCustomAlert('ì €ì¥ ì‹¤íŒ¨!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    async function applyFixedSchedule() {
       console.log('applyFixedSchedule í˜¸ì¶œë¨');  // â† ì´ê±° ì¶”ê°€! í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸ìš©
      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const daysInMonth = new Date(year, month + 1, 0).getDate(); // í•œ ì¤„ë¡œ í•©ì³ì„œ ëª…í™•í•˜ê²Œ
      
      const today = formatDate(new Date());
      const slotsToAdd = [];
      let skippedCount = 0;
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = formatDate(date);
        const dayOfWeek = date.getDay();
        console.log('ì¶”ê°€í•  ìŠ¬ë¡¯:', slotsToAdd.length, 'ê±´ë„ˆëœ€:', skippedCount);  // â† ì´ê²ƒë„ ì¶”ê°€!
        // ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œëŠ” ìŠ¤í‚µ
        if (dateStr < today) continue;
        
        // í•´ë‹¹ ìš”ì¼ì˜ ê³ ì • ì¼ì •ì´ ìˆëŠ”ì§€ í™•ì¸
        const schedules = fixedSchedule[dayOfWeek];
        if (!schedules) continue;
        
        // ì´ë¯¸ ìŠ¬ë¡¯ì´ ìˆëŠ” ë‚ ì§œì¸ì§€ í™•ì¸
        const existingSlots = state.availableSlots.filter(s => s.date === dateStr);
        
        for (const schedule of schedules) {
          // ê°™ì€ ë°©, ê°™ì€ ì‹œê°„ëŒ€ì˜ ìŠ¬ë¡¯ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
          const isDuplicate = existingSlots.some(s => 
            s.room === schedule.room && 
            s.startTime === schedule.startTime && 
            s.endTime === schedule.endTime
          );
          
          if (isDuplicate) {
            skippedCount++;
          } else {
            slotsToAdd.push({
              id: `${Date.now()}_${day}_${schedule.room}_${schedule.startTime.replace(':', '')}`,
              date: dateStr,
              room: schedule.room,
              startTime: schedule.startTime,
              endTime: schedule.endTime,
              teacher: schedule.teacher,           // âœ¨ ì¶”ê°€ë¨
              testStartTime: schedule.testStartTime // âœ¨ ì¶”ê°€ë¨
            });
          }
        }
      }
      
      if (slotsToAdd.length === 0) {
        showCustomAlert(`ì´ë¯¸ ëª¨ë“  ê³ ì • ì¼ì •ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n(${skippedCount}ê°œ ê±´ë„ˆëœ€)`);
        return;
      }
      
      const message = `${year}ë…„ ${month + 1}ì›”ì— ${slotsToAdd.length}ê°œì˜ ê³ ì • ì¼ì •ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(${skippedCount}ê°œëŠ” ì´ë¯¸ ì¡´ì¬í•˜ì—¬ ê±´ë„ˆëœ€)\n\n`;
          
      showCustomConfirm(message, async () => {
        state.syncing = true;
        render();
        
        try {
          // ëª¨ë“  ìŠ¬ë¡¯ì„ í•œ ë²ˆì— ì¶”ê°€
          const formData = new FormData();
          formData.append('sheet', 'slots');
          formData.append('action', 'addBatch');
          formData.append('data', JSON.stringify(slotsToAdd));
          
          await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
          await loadFromGoogleSheets();
          
          const resultMessage = skippedCount > 0
            ? `ì ìš© ì™„ë£Œ!\n\n${slotsToAdd.length}ê°œ ì¶”ê°€ë¨\n${skippedCount}ê°œ ê±´ë„ˆëœ€`
            : `ì ìš© ì™„ë£Œ!\n\n${slotsToAdd.length}ê°œ ì¶”ê°€ë¨`;
          
          showCustomAlert(resultMessage);
        } catch (error) {
          console.error('ê³ ì • ì¼ì • ì¶”ê°€ ì—ëŸ¬:', error);
          showCustomAlert('ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          state.syncing = false;
          render();
        }
      });
    }

    function openBookingForm(bookingId = null) {
      if (bookingId) {
        console.log('Looking for booking ID:', bookingId, 'Type:', typeof bookingId);
        console.log('Available bookings:', state.bookings.map(b => ({ id: b.id, type: typeof b.id })));
        
        // IDë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
        const booking = state.bookings.find(b => String(b.id) === String(bookingId));
        if (!booking) {
          console.error('Booking not found:', bookingId);
          console.log('All booking IDs:', state.bookings.map(b => b.id));
          showCustomAlert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        console.log('Found booking:', booking);
        state.editingBooking = String(bookingId);
        state.bookingForm = {
          studentName: booking.studentName || '',
          school: booking.school || '',
          grade: booking.grade || 'elementary1',
          hasLevelTest: booking.hasLevelTest || false,
          date: booking.date || '',
          time: booking.consultTime || booking.time || '',
          room: booking.consultRoom || booking.room || '',
          consultMode: booking.consultMode || 'in_person',
          testRoom: booking.testRoom || ''
        };
      } else {
        state.editingBooking = null;
        state.bookingForm = {
          studentName: '',
          school: '',
          grade: 'elementary1',
          hasLevelTest: false,
          date: state.selectedDate || formatDate(new Date()),
          time: '',
          room: '',
          consultMode: 'in_person',
          testRoom: ''
        };
      }
      state.showBookingForm = true;
      render();
    }

    function getAvailableTimes() {
      if (!state.bookingForm.date) return [];
      const dateStr = state.bookingForm.date;
      const step = 5;
      const CONSULT_DURATION = 30;

      const g = String(state.bookingForm.grade||'').trim();
      const isElementary = g.startsWith('elementary') || g==='elementary' ||
        ['ì´ˆ','ì´ˆ1','ì´ˆ2','ì´ˆ3','ì´ˆ4','ì´ˆ5','ì´ˆ6'].some(k=>g.includes(k));
      const levelTestMins = state.bookingForm.hasLevelTest ? (isElementary?40:50) : 0;

      const isPhone = (state.bookingForm.consultMode === 'phone');
      const isTestOnly = (isPhone && state.bookingForm.hasLevelTest);

      const slotsAll = (state.availableSlots||[]).filter(s => (s.date||'')===dateStr);
      
      const bookings = (state.bookings||[])
        .filter(r => (r.date||'')===dateStr)
        .map(r => ({
          room: norm(r.room),
          startM: timeToMins(r.time),
          endM: timeToMins(r.endTime)
        }));

      const out = new Set();

      if (isTestOnly) {
        const chosen = norm(state.bookingForm.testRoom);
        if (!chosen) return [];

        const win = getOpenWindow(dateStr, chosen);
        if (!win) return [];

        const sM = timeToMins(win[0]);
        const eM = timeToMins(win[1]);
        const required = levelTestMins + CONSULT_DURATION;

        for (let tStart = sM; tStart <= eM - required; tStart += step) {
          const tEnd = tStart + required;
          let conflict = false;
          for (const r of bookings) {
            if (r.room.startsWith(chosen)) {
              if (!(tEnd <= r.startM || tStart >= r.endM)) {
                conflict = true;
                break;
              }
            }
          }
          if (!conflict) out.add(minsToTime(tStart));
        }
        return Array.from(out).sort();
      }

      const consultSlots = isPhone
        ? slotsAll.filter(s => /^(2|5)ê´€/.test(norm(s.room)))
        : slotsAll.filter(s => norm(s.room)===norm(state.bookingForm.room));

      for (const slot of consultSlots) {
        const sM = timeToMins(slot.startTime);
        const eM = timeToMins(slot.endTime);
        if (!Number.isFinite(sM)||!Number.isFinite(eM)||eM<=sM) continue;

        for (let tStart = sM; tStart <= eM - CONSULT_DURATION; tStart += step) {
          const tEnd = tStart + CONSULT_DURATION;
          let conflict = false;
          for (const r of bookings) {
            if (isPhone) {
              if (r.room === norm(slot.room)) {
                if (!(tEnd <= r.startM || tStart >= r.endM)) {
                  conflict = true;
                  break;
                }
              }
            } else {
              if (r.room === norm(state.bookingForm.room)) {
                if (!(tEnd <= r.startM || tStart >= r.endM)) {
                  conflict = true;
                  break;
                }
              }
            }
          }
          if (!conflict) out.add(minsToTime(tStart));
        }
      }
      return Array.from(out).sort();
    }

    async function addBooking() {
      const f = state.bookingForm;
      const isPhone = (f.consultMode === 'phone');
      const isTestOnly = (isPhone && f.hasLevelTest);

      if (!f.studentName || !f.date || !f.time) {
        return showCustomAlert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }
      if (!isPhone && !f.room) {
        return showCustomAlert('ìƒë‹´ì‹¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      }
      if (isTestOnly && !f.testRoom) {
        return showCustomAlert('ë ˆë²¨í…ŒìŠ¤íŠ¸ ì¥ì†Œ(2ê´€/5ê´€)ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      }
      if (f.hasLevelTest && f.grade === 'unknown') {
        return showCustomAlert('í•™ë…„ì„ ëª¨ë¥´ëŠ” ê²½ìš° ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹œê°„ì„ ì •í™•íˆ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      const g = String(f.grade||'').trim();
      const isElementary = g.startsWith('elementary') || g === 'elementary' ||
        ['ì´ˆ','ì´ˆ1','ì´ˆ2','ì´ˆ3','ì´ˆ4','ì´ˆ5','ì´ˆ6'].some(k=>g.includes(k));
      const levelTestMins = f.hasLevelTest ? (isElementary ? 40 : 50) : 0;

      let consultTime, startTime, endTime;

      if (isTestOnly) {
        startTime = f.time;
        consultTime = addMinutesToTime(f.time, levelTestMins);
        endTime = addMinutesToTime(consultTime, 30);
      } else {
        consultTime = f.time;
        const consultEndTime = addMinutesToTime(consultTime, 30);
        startTime = levelTestMins > 0 ? addMinutesToTime(consultTime, -levelTestMins) : consultTime;
        endTime = consultEndTime;
      }

      const candidates = getAvailableTimes();
      if (!candidates.includes(f.time)) {
        return showCustomAlert('ì„ íƒí•œ ì‹œê°„ì€ ì˜ˆì•½ ê·œì¹™(ìƒë‹´/í…ŒìŠ¤íŠ¸ ìŠ¬ë¡¯, ì¶©ëŒ)ê³¼ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }

      state.syncing = true;
      render();

      try {
        const bookingData = {
          studentName: f.studentName,
          school: f.school || 'ëª¨ë¦„',
          grade: f.grade,
          hasLevelTest: f.hasLevelTest,
          date: f.date,
          time: startTime,
          endTime: endTime,
          consultTime: consultTime,
          status: 'scheduled',
          consultMode: f.consultMode,
          testRoom: f.hasLevelTest ? f.testRoom : '',
          consultRoom: f.consultMode==='in_person' ? f.room : 'ì „í™”ìƒë‹´',
          room: f.hasLevelTest ? (f.testRoom || f.room || '') : (f.consultMode==='in_person' ? f.room : 'ì „í™”ìƒë‹´')
        };

        if (state.editingBooking) {
          const existing = state.bookings.find(b => String(b.id) === String(state.editingBooking));
          if (!existing) {
            showCustomAlert('ìˆ˜ì •í•  ì˜ˆì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            state.syncing = false;
            return;
          }
          await updateInGoogleSheets('bookings', state.editingBooking, { ...existing, ...bookingData });
          showCustomAlert('ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
          const newBooking = { id: Date.now().toString(), ...bookingData };
          await addToGoogleSheets('bookings', newBooking);
          showCustomAlert('ì˜ˆì•½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        state.showBookingForm = false;
        state.editingBooking = null;
        render();
      } catch (e) {
        console.error(e);
        showCustomAlert('ì˜ˆì•½ ì²˜ë¦¬ ì‹¤íŒ¨!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    async function updateBookingStatus(id, status, reason = '') {
      state.syncing = true;
      render();
      
      try {
        const booking = state.bookings.find(b => String(b.id) === String(id));
        if (!booking) return;
        
        const updatedBooking = {
          ...booking,
          status: status,
          cancelReason: reason || '',
          completedAt: status === 'completed' ? new Date().toISOString() : booking.completedAt
        };
        
        await updateInGoogleSheets('bookings', id, updatedBooking);
        
        showCustomAlert(status === 'completed' ? 'ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ë¯¸ì§„í–‰ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (error) {
        console.error('ì—ëŸ¬:', error);
        showCustomAlert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨!');
      } finally {
        state.syncing = false;
        state.showReasonModal = false;
        state.selectedBookingId = null;
        state.cancelReason = '';
        state.cancelReasonType = '';
        render();
      }
    }

    function openReasonModal(id) {
      state.selectedBookingId = String(id);
      state.showReasonModal = true;
      state.cancelReason = '';
      state.cancelReasonType = '';
      render();
    }

    function submitCancelReason() {
      if (!state.cancelReasonType) {
        showCustomAlert('ë¯¸ì§„í–‰ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      if (state.cancelReasonType === 'ê¸°íƒ€' && !state.cancelReason.trim()) {
        showCustomAlert('ê¸°íƒ€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      const finalReason = state.cancelReasonType === 'ê¸°íƒ€' ? state.cancelReason : state.cancelReasonType;
      updateBookingStatus(state.selectedBookingId, 'cancelled', finalReason);
    }

    async function deleteSlot(id) {
      showCustomConfirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‹œê°„ëŒ€ì— ì˜ˆì•½ëœ ìƒë‹´ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.', async () => {
        state.syncing = true;
        render();
        
        try {
          await deleteFromGoogleSheets('slots', id);
          showCustomAlert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (error) {
          showCustomAlert('ì‚­ì œ ì‹¤íŒ¨!');
        } finally {
          state.syncing = false;
          render();
        }
      });
    }

    async function deleteBooking(id) {
      showCustomConfirm('ì •ë§ ì´ ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        state.syncing = true;
        render();
        
        try {
          await deleteFromGoogleSheets('bookings', id);
          showCustomAlert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (error) {
          showCustomAlert('ì‚­ì œ ì‹¤íŒ¨!');
        } finally {
          state.syncing = false;
          render();
        }
      });
    }

    function prevMonth() {
      state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() - 1, 1);
      render();
    }

    function nextMonth() {
      state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1, 1);
      render();
    }

    function renderCalendar() {
      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      const today = formatDate(new Date());
      const oneMonthAgo = getOneMonthAgo();
      
      let html = '';
      
      for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="h-20"></div>';
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = formatDate(date);
        const hasSlots = state.availableSlots.some(slot => slot.date === dateStr);
        const hasBooking = state.bookings.some(booking => booking.date === dateStr);
        const isSelected = state.selectedDate === dateStr;
        const isToday = dateStr === today;
        const isPast = dateStr < today;
        const isTooOld = dateStr < oneMonthAgo;
        
        let classes = 'h-20 border p-2 transition rounded-lg overflow-hidden ';
        if (isTooOld) {
          classes += 'bg-gray-100 opacity-50 text-gray-400 cursor-default';
        } else if (isPast) {
          classes += 'bg-gray-200 cursor-pointer opacity-70';
        } else if (isSelected) {
          classes += 'bg-indigo-200 border-indigo-600 ring-2 ring-indigo-400 cursor-pointer shadow-md';
        } else if (hasSlots || hasBooking) {
          classes += 'bg-white hover:bg-green-100 cursor-pointer shadow-sm border-gray-200';
        } else {
          classes += 'bg-white hover:bg-gray-50 cursor-pointer shadow-sm border-gray-200';
        }
        if (isToday) classes += ' ring-2 ring-blue-500 ring-offset-2';
        
        html += '<div class="' + classes + '" onclick="handleDateClick(\'' + dateStr + '\', ' + (isPast && !isTooOld) + ')">';
        html += '<div class="font-semibold text-sm ' + (isPast ? 'text-gray-500' : 'text-gray-800') + '">' + day + '</div>';
        html += '<div class="flex justify-center gap-1 mt-1">';
        if (hasSlots) {
          html += '<div title="ìƒë‹´ ê°€ëŠ¥" class="w-3 h-3 bg-green-500 rounded-full"></div>';
        }
        if (hasBooking) {
          html += '<div title="ì˜ˆì•½ ìˆìŒ" class="w-3 h-3 bg-blue-500 rounded-full"></div>';
        }
        html += '</div></div>';
      }
      
      return html;
    }

    function handleDateClick(dateStr, isPast) {
      state.selectedDate = dateStr;
      if (!isPast) {
        state.bookingForm.date = dateStr;
      }
      render();
    }

    function generateTimeOptions(dateStr) {
      const options = [];
      const weekend = isWeekend(dateStr);
      const startHour = weekend ? 10 : 15;
      const endHour = 22;
      
      for (let h = startHour; h <= endHour; h++) {
        for (let m = 0; m < 60; m += 5) {
          const time = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
          options.push(time);
        }
      }
      return options;
    }

    function render() {
      const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
      const selectedSlots = state.availableSlots.filter(s => s.date === state.selectedDate);
      const selectedBookings = state.bookings
        .filter(b => (b.date || '').startsWith(state.selectedDate))
        .sort((a, b) => a.time.localeCompare(b.time));
      const allRooms = [...new Set(state.availableSlots.map(s => s.room))].sort();
      const availableRoomsForSelectedDate = [...new Set(state.availableSlots.filter(s => s.date === state.selectedDate).map(s => s.room))].sort();
      const today = formatDate(new Date());
      const bookings = state.bookings || [];
      const todayBookings = bookings
        .filter(b => (b.date || '').startsWith(today))
        .sort((a, b) => a.time.localeCompare(b.time));
      
      let html = '<div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">';
      html += '<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">';
      html += '<h1 class="text-3xl font-extrabold text-gray-800">ğŸ“… ìƒë‹´ ì˜ˆì•½ ì‹œìŠ¤í…œ</h1>';
      html += '<div class="flex gap-2">';
      html += '<button onclick="state.showHistoryModal = true; render();" class="bg-purple-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-purple-600 transition shadow-md">ğŸ“‹ ì§€ë‚œ ë‚´ì—­</button>';
      html += '<button onclick="loadFromGoogleSheets()" ' + (state.loading || state.syncing ? 'disabled' : '') + ' class="bg-green-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-green-600 transition disabled:opacity-50 shadow-md">';
      html += 'ğŸ”„ ' + (state.loading ? 'ë¡œë”©ì¤‘...' : state.syncing ? 'ë™ê¸°í™”ì¤‘...' : 'ìƒˆë¡œê³ ì¹¨');
      html += '</button></div></div>';

      if (state.loading) {
        html += '<div class="text-center py-20">';
        html += '<div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>';
        html += '<p class="mt-4 text-gray-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        html += '</div>';
      } else {
        html += '<div class="mb-8 bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200 shadow-lg">';
        html += '<h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ”” ì˜¤ëŠ˜ì˜ ìƒë‹´ ì˜ˆì•½ (' + today + ')</h2>';
        
        if (todayBookings.length === 0) {
          html += '<p class="text-gray-500 text-center py-8">ì˜¤ëŠ˜ ì˜ˆì•½ëœ ìƒë‹´ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          html += '<div class="space-y-3">';
          for (let booking of todayBookings) {
            const statusColor = booking.status === 'completed' ? 'bg-green-100 border-green-400' : 
                               booking.status === 'cancelled' ? 'bg-red-100 border-red-400' : 
                               'bg-white border-blue-400';
            const statusText = booking.status === 'completed' ? 'âœ“ ì™„ë£Œ' : booking.status === 'cancelled' ? 'âœ— ë¯¸ì§„í–‰' : 'â³ ì˜ˆì •';
            
            html += '<div class="' + statusColor + ' border-2 p-4 rounded-xl flex justify-between items-center shadow-md">';
            html += '<div class="flex-1">';
            html += '<div class="text-lg font-semibold text-gray-800 mb-1">';
            html += '<span class="text-indigo-600">' + booking.room + '</span> | ';
            html += booking.school + ' ' + gradeLabels[booking.grade] + ' | ';
            html += '<span class="text-blue-700">' + booking.studentName + '</span>';
            html += ' <span class="text-sm font-medium ' + (booking.status === 'completed' ? 'text-green-600' : booking.status === 'cancelled' ? 'text-red-600' : 'text-orange-600') + '">' + statusText + '</span>';
            html += '</div>';
            html += '<div class="flex items-center gap-4 text-gray-600 text-sm">';
            html += '<span class="font-medium">ğŸ• ' + booking.time + ' - ' + booking.endTime + '</span>';
            html += '<span class="text-indigo-600 font-medium">' + (booking.hasLevelTest ? 'ë ˆë²¨í…ŒìŠ¤íŠ¸ + ìƒë‹´' : 'ìƒë‹´') + '</span>';
            html += '</div>';
            if (booking.hasLevelTest) {
              html += '<p class="text-xs text-gray-500 mt-1">ìƒë‹´ ì‹œì‘ ì‹œê°„: ' + booking.consultTime + '</p>';
            }
            if (booking.status === 'cancelled' && booking.cancelReason) {
              html += '<p class="text-sm text-red-700 mt-2 bg-red-50 p-2 rounded-lg border border-red-200">ë¯¸ì§„í–‰ ì‚¬ìœ : ' + booking.cancelReason + '</p>';
            }
            html += '</div>';
            
            if (booking.status === 'scheduled') {
              html += '<div class="flex flex-col gap-2 ml-4">';
              html += '<button onclick="updateBookingStatus(\'' + String(booking.id) + '\', \'completed\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 disabled:opacity-50 shadow-md">âœ“ ì™„ë£Œ</button>';
              html += '<button onclick="openReasonModal(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-orange-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-orange-600 disabled:opacity-50 shadow-md">âœ— ë¯¸ì§„í–‰</button>';
              html += '</div>';
            }
            
            html += '</div>';
          }
          html += '</div>';
        }
        html += '</div>';

        html += '<div class="mb-8">';
        html += '<div class="flex justify-between items-center mb-4">';
        html += '<h2 class="text-2xl font-bold text-gray-800">ğŸ“… ìº˜ë¦°ë”</h2>';
        html += '<div class="flex items-center gap-4">';
        html += '<button onclick="applyFixedSchedule()" ' + (state.syncing ? 'disabled' : '') + ' class="bg-purple-500 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-purple-600 transition disabled:opacity-50 shadow-md">ğŸ“Œ ê³ ì • ì¼ì • ì ìš©</button>';
        html += '<button onclick="prevMonth()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full transition">â—€</button>';
        html += '<span class="text-xl font-bold text-indigo-700">' + state.currentDate.getFullYear() + 'ë…„ ' + monthNames[state.currentDate.getMonth()] + '</span>';
        html += '<button onclick="nextMonth()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full transition">â–¶</button>';
        html += '</div></div>';
        
        html += '<div class="mb-4 flex gap-4 text-sm text-gray-600 justify-center">';
        html += '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-green-500 rounded-full"></div><span>ìƒë‹´ ê°€ëŠ¥ ì‹œê°„</span></div>';
        html += '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-blue-500 rounded-full"></div><span>ì˜ˆì•½ëœ ìƒë‹´</span></div>';
        html += '</div>';

        html += '<div class="grid grid-cols-7 gap-1 mb-2 calendar-grid">';
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        for (let i = 0; i < days.length; i++) {
          const dayClass = i === 0 ? 'text-red-500' : i === 6 ? 'text-blue-500' : 'text-gray-600';
          html += '<div class="text-center font-bold p-2 ' + dayClass + '">' + days[i] + '</div>';
        }
        html += '</div>';
        
        html += '<div class="grid grid-cols-7 gap-1 calendar-grid">';
        html += renderCalendar();
        html += '</div></div>';

        if (state.selectedDate) {
          const isPastDate = state.selectedDate < today;
          html += '<div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200 space-y-8">';
          html += '<div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">' + state.selectedDate + ' ìƒì„¸ ì •ë³´</h2>';
          html += '<button onclick="state.selectedDate = null; render();" class="text-gray-500 hover:text-gray-800 text-sm">X ë‹«ê¸°</button></div>';

          html += '<div><div class="flex justify-between items-center mb-3">';
          html += '<h3 class="font-semibold text-xl text-gray-800">ğŸ—“ï¸ ìƒë‹´ ê°€ëŠ¥ ì‹œê°„</h3>';
          if (!isPastDate) {
            html += '<button onclick="openSlotForm(\'' + state.selectedDate + '\')" class="bg-indigo-600 text-white px-3 py-1 rounded-xl text-sm font-semibold hover:bg-indigo-700 shadow-md transition">+ ì‹œê°„ ì¶”ê°€</button>';
          }
          html += '</div><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">';
          
          if (selectedSlots.length === 0) {
            html += '<p class="text-gray-500 text-sm py-4">ì´ ë‚ ì§œì— ì„¤ì •ëœ ìƒë‹´ ê°€ëŠ¥ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          } else {
            for (let slot of selectedSlots) {
              html += '<div class="bg-green-50 p-3 rounded-xl border border-green-300 flex justify-between items-center shadow-sm">';
              html += '<div><div class="font-medium text-green-700">' + slot.room + '</div>';
              html += '<div class="text-base font-bold text-gray-800">' + slot.startTime + ' - ' + slot.endTime + '</div></div>';
              html += '<div class="text-base font-bold text-gray-800">' + slot.startTime + ' - ' + slot.endTime + '</div>';
              if (slot.testStartTime) { // âœ¨ ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹œê°„ ì¶”ê°€
                html += '<div class="text-xs text-blue-600 mt-1">ë ˆë²¨í…ŒìŠ¤íŠ¸: ' + slot.testStartTime + 'ë¶€í„° ê°€ëŠ¥</div>';
              }
              if (!isPastDate) {
                html += '<button onclick="deleteSlot(\'' + slot.id + '\')" class="text-red-500 hover:text-red-700 p-1 text-lg">ğŸ—‘ï¸</button>';
              }
              html += '</div>';
            }
          }
          html += '</div></div>';

          html += '<div><div class="flex justify-between items-center mb-3">';
          html += '<h3 class="font-semibold text-xl text-gray-800">ğŸ‘¥ ì˜ˆì•½ í˜„í™©</h3>';
          if (!isPastDate && selectedSlots.length > 0) {
            html += '<button onclick="state.bookingForm.date = \'' + state.selectedDate + '\'; state.showBookingForm = true; render();" class="bg-blue-600 text-white px-3 py-1 rounded-xl text-sm font-semibold hover:bg-blue-700 shadow-md transition">+ ì‹ ê·œ ì˜ˆì•½</button>';
          }
          html += '</div><div class="space-y-3">';
          
          if (selectedBookings.length === 0) {
            html += '<p class="text-gray-500 text-sm py-4">ì´ ë‚ ì§œì— ì˜ˆì•½ëœ ìƒë‹´ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          } else {
            for (let booking of selectedBookings) {
              const statusColor = booking.status === 'completed' ? 'bg-green-50 border-green-300' : 
                                  booking.status === 'cancelled' ? 'bg-red-50 border-red-300' : 
                                  'bg-blue-50 border-blue-300';
              const statusText = booking.status === 'completed' ? 'âœ“ ì™„ë£Œ' : booking.status === 'cancelled' ? 'âœ— ë¯¸ì§„í–‰' : 'â³ ì˜ˆì •';
              
              html += '<div class="' + statusColor + ' p-4 rounded-xl border flex justify-between items-start shadow-sm">';
              html += '<div class="flex-1">';
              html += '<div class="text-lg font-bold text-gray-800">';
              html += '<span class="text-indigo-600">' + booking.room + '</span> | ';
              html += '<span class="text-gray-700">' + gradeLabels[booking.grade] + ' ' + booking.studentName + '</span>';
              html += ' <span class="text-sm font-medium ' + (booking.status === 'completed' ? 'text-green-600' : booking.status === 'cancelled' ? 'text-red-600' : 'text-orange-600') + '">' + statusText + '</span>';
              html += '</div>';
              html += '<div class="text-sm text-gray-600 mt-1">';
              html += '<span>ğŸ• ' + booking.time + ' - ' + booking.endTime + '</span>';
              html += '<span class="mx-2">|</span>';
              html += '<span class="text-indigo-600 font-medium">' + (booking.hasLevelTest ? 'ë ˆë²¨í…ŒìŠ¤íŠ¸ + ìƒë‹´' : 'ìƒë‹´') + '</span>';
              html += '<span class="mx-2">|</span>';
              html += '<span class="text-gray-500">í•™êµ: ' + booking.school + '</span>';
              html += '</div>';

              if (booking.hasLevelTest) {
                html += '<p class="text-xs text-gray-500 mt-1">ìƒë‹´ ì‹œì‘: ' + booking.consultTime + ' / í…ŒìŠ¤íŠ¸ ì‹œì‘: ' + booking.time + '</p>';
              }
              if (booking.status === 'cancelled' && booking.cancelReason) {
                html += '<p class="text-sm text-red-700 mt-2 bg-red-100 p-2 rounded-lg border border-red-300">ë¯¸ì§„í–‰ ì‚¬ìœ : ' + booking.cancelReason + '</p>';
              }
              html += '</div>';

              html += '<div class="flex flex-col gap-1 ml-4">';
              if (booking.status === 'scheduled') {
                html += '<button onclick="updateBookingStatus(\'' + String(booking.id) + '\', \'completed\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-green-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-green-600 disabled:opacity-50 shadow-sm">âœ“ ì™„ë£Œ</button>';
                html += '<button onclick="openReasonModal(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-orange-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-orange-600 disabled:opacity-50 shadow-sm">âœ— ë¯¸ì§„í–‰</button>';
              }
              html += '<button onclick="openBookingForm(\'' + booking.id + '\')" class="bg-yellow-400 text-white px-3 py-1 rounded-lg text-xs hover:bg-yellow-500 shadow-sm">âœï¸ ìˆ˜ì •</button>';
              html += '<button onclick="deleteBooking(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-red-50 text-red-700 border border-red-300 px-3 py-1 rounded-lg text-xs hover:bg-red-100 disabled:opacity-50 shadow-sm">ì‚­ì œ</button>';
              html += '</div></div>';
            }
          }
          html += '</div></div>';
          html += '</div>';
        }
      }
      
      html += '</div>';

      if (state.showSlotForm) {
        const timeOptions = generateTimeOptions(state.slotForm.date);
        
        html += '<div class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4" onclick="if(event.target.classList.contains(\'bg-opacity-75\')) { state.showSlotForm = false; render(); }">';
        html += '<div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 md:p-8 transform transition-all scale-100">';
        html += '<h3 class="text-2xl font-bold text-gray-800 mb-6">â• ìƒë‹´ ê°€ëŠ¥ ì‹œê°„ ì¶”ê°€</h3>';
        
        html += '<div class="space-y-4">';
        
        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>';
        html += '<input type="date" value="' + state.slotForm.date + '" onchange="state.slotForm.date = this.value; render();" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required></div>';

        if (state.slotForm.date) {
          const isWeekendDate = isWeekend(state.slotForm.date);
          html += '<div class="text-sm p-3 rounded-lg ' + (isWeekendDate ? 'bg-blue-50 text-blue-700' : 'bg-green-50 text-green-700') + '">';
          html += isWeekendDate ? 'ğŸ“… ì£¼ë§: 10:00~21:00 ì‚¬ì´ ì„ íƒ ê°€ëŠ¥' : 'ğŸ“… ì£¼ì¤‘: 15:00~22:00 ì‚¬ì´ ì„ íƒ ê°€ëŠ¥';
          html += '</div>';
        }

        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">ìƒë‹´ì‹¤</label>';
        html += '<select onchange="state.slotForm.room = this.value; render();" ...>';
        html += '<option value="">ì„ íƒ</option>';
        html += '<option value="í•˜ì•ˆê´€" ...>í•˜ì•ˆê´€</option>'; // âœ¨ í•˜ì•ˆê´€/ì² ì‚°ê´€ ê³ ì • ì„ íƒ
        html += '<option value="ì² ì‚°ê´€" ...>ì² ì‚°ê´€</option>';
        html += '</select></div>';
        
        // âœ¨ ë‹´ë‹¹ ì„ ìƒë‹˜ ì…ë ¥ ì¶”ê°€
        html += '<div><label>ë‹´ë‹¹ ì„ ìƒë‹˜</label>';
        html += '<input type="text" value="' + (state.slotForm.teacher || '') + '" 
                 oninput="state.slotForm.teacher = this.value;" 
                 placeholder="ì„ ìƒë‹˜ ì´ë¦„ ì…ë ¥"></div>';
        
        // âœ¨ ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹œì‘ ê°€ëŠ¥ ì‹œê°„ ì¶”ê°€
        html += '<div><label>ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹œì‘ ê°€ëŠ¥ ì‹œê°„</label>';
        html += '<select onchange="state.slotForm.testStartTime = this.value; render();" ...>';
        html += '<option value="">ì„ íƒ ì•ˆí•¨ (ë ˆë²¨í…ŒìŠ¤íŠ¸ ë¶ˆê°€)</option>';
        
        // ... ì‹œê°„ ì˜µì…˜ë“¤
        html += '</select>';
        html += '<p class="text-xs text-gray-500 mt-1">ë ˆë²¨í…ŒìŠ¤íŠ¸ê°€ ì‹œì‘ ê°€ëŠ¥í•œ ê°€ì¥ ì´ë¥¸ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”</p>';
        html += '</div>';
        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œ ì‹œê°„ (24ì‹œê°„ í‘œê¸°)</label>';
        html += '<select onchange="state.slotForm.endTime = this.value; render();" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>';
        html += '<option value="">ì„ íƒ</option>';
        timeOptions.forEach(time => {
          html += '<option value="' + time + '" ' + (state.slotForm.endTime === time ? 'selected' : '') + '>' + time + '</option>';
        });
        html += '</select></div>';
        
        html += '</div>';

        html += '<div class="flex justify-end gap-3 mt-8">';
        html += '<button onclick="state.showSlotForm = false; render();" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition shadow-md">ì·¨ì†Œ</button>';
        html += '<button onclick="addSlot()" ' + (state.syncing ? 'disabled' : '') + ' class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600 transition disabled:opacity-50 shadow-md">ì €ì¥</button>';
        html += '</div>';
        html += '</div></div>';
      }

      if (state.showBookingForm) {
        const availableTimes = getAvailableTimes();
        const isPhone = (state.bookingForm.consultMode === 'phone');
        const isTestOnly = (isPhone && state.bookingForm.hasLevelTest);
        
        html += '<div class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4" onclick="if(event.target.classList.contains(\'bg-opacity-75\')) { state.showBookingForm = false; render(); }">';
        html += '<div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 md:p-8 transform transition-all scale-100">';
        html += '<h3 class="text-2xl font-bold text-gray-800 mb-6">' + (state.editingBooking ? 'âœï¸ ìƒë‹´ ì˜ˆì•½ ìˆ˜ì •' : 'â• ìƒë‹´ ì˜ˆì•½ ë“±ë¡') + ' (' + state.bookingForm.date + ')</h3>';
        
        html += '<div class="space-y-4">';

        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">í•™ìƒ ì´ë¦„</label>';
        html += '<input type="text" value="' + (state.bookingForm.studentName || '') + '" oninput="state.bookingForm.studentName = this.value;" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required placeholder="í•™ìƒ ì´ë¦„"></div>';
        
        html += '<div class="flex gap-4">';
        html += '<div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">í•™êµ</label>';
        html += '<input type="text" value="' + (state.bookingForm.school || '') + '" oninput="state.bookingForm.school = this.value;" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="í•™êµëª… (ëª¨ë¥¼ ê²½ìš° \'ëª¨ë¦„\')"></div>';

        html += '<div class="w-1/3"><label class="block text-sm font-medium text-gray-700 mb-1">í•™ë…„</label>';
        html += '<select onchange="state.bookingForm.grade=this.value; state.bookingForm.time=\'\'; render();" class="w-full p-3 border rounded-lg" required>';
        ['elementary1','elementary2','elementary3','elementary4','elementary5','elementary6', 'middle1','middle2','middle3','high1','high2','high3','unknown'].forEach(g => {
          html += '<option value="' + g + '" ' + (state.bookingForm.grade === g ? 'selected' : '') + '>' + gradeLabels[g] + '</option>';
        });
        html += '</select></div></div>';
        
        html += '<div class="flex items-center">';
        html += '<input id="hasLevelTest" type="checkbox" ' + (state.bookingForm.hasLevelTest ? 'checked' : '') + ' onchange="state.bookingForm.hasLevelTest=this.checked; state.bookingForm.time=\'\'; if(state.bookingForm.consultMode===\'phone\'){ state.bookingForm.testRoom=\'\'; } render();" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">';
        html += '<label for="hasLevelTest" class="ml-2 block text-sm text-gray-900">ë ˆë²¨í…ŒìŠ¤íŠ¸ ë³‘í–‰ (ì´ˆë“± 40ë¶„, ì¤‘/ê³ ë“± 50ë¶„ ì¶”ê°€)</label>';
        html += '</div>';

        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">ìƒë‹´ ë°©ì‹</label>';
        html += '<select onchange="state.bookingForm.consultMode=this.value; if(this.value===\'phone\'){ state.bookingForm.room=\'\'; state.bookingForm.testRoom=\'\'; } state.bookingForm.time=\'\'; render();" class="w-full p-3 border rounded-lg">';
        html += '<option value="in_person" ' + (state.bookingForm.consultMode==='in_person'?'selected':'') + '>ëŒ€ë©´(ìƒë‹´ì‹¤ í•„ìš”)</option>';
        html += '<option value="phone" ' + (state.bookingForm.consultMode==='phone'?'selected':'') + '>ì „í™”ìƒë‹´(ì¥ì†Œ ë¬´ê´€)</option>';
        html += '</select></div>';
        
        if (state.bookingForm.hasLevelTest && state.bookingForm.grade === 'unknown') {
          html += '<div class="text-sm text-red-600 p-3 bg-red-50 rounded-lg border border-red-200">âš ï¸ í•™ë…„ì„ ëª¨ë¥´ëŠ” ê²½ìš° ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹œê°„ì„ ì •í™•íˆ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•™ë…„ì„ ì„ íƒí•˜ê±°ë‚˜ ë ˆë²¨í…ŒìŠ¤íŠ¸ ì˜µì…˜ì„ í•´ì œí•´ì£¼ì„¸ìš”.</div>';
        }

        if (isTestOnly) {
          if (!state.bookingForm.testRoom) {
            const candidates = ['2ê´€','5ê´€'];
            html += '<div class="mt-2"><label class="block text-sm font-medium text-gray-700 mb-1">ë ˆë²¨í…ŒìŠ¤íŠ¸ ì¥ì†Œ</label>';
            html += '<select onchange="state.bookingForm.testRoom=this.value; state.bookingForm.time=\'\'; render();" class="w-full p-3 border rounded-lg" required>';
            html += '<option value="">ì„ íƒ</option>';
            candidates.forEach(r=>{ html += '<option value="' + r + '">' + r + '</option>'; });
            html += '</select></div>';
            html += '<p class="text-sm text-indigo-700 p-3 bg-indigo-50 rounded-lg mt-2">ë ˆë²¨í…ŒìŠ¤íŠ¸ ì¥ì†Œë¥¼ ë¨¼ì € ì„ íƒí•˜ë©´ ì‹œì‘ ê°€ëŠ¥í•œ ì‹œê°„ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
          } else {
            html += '<div class="text-sm text-indigo-700 p-3 bg-indigo-50 rounded-lg">ì„ íƒëœ í…ŒìŠ¤íŠ¸ì‹¤: <b>' + state.bookingForm.testRoom + '</b></div>';
          }
        } else if (isPhone) {
          html += '<div class="text-sm text-indigo-700 p-3 bg-indigo-50 rounded-lg">ì „í™”ìƒë‹´ì€ ìƒë‹´ì‹¤ ì„ íƒì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
          const roomsForDate = [...new Set((state.availableSlots||[])
            .filter(s => (s.date||'') === state.bookingForm.date)
            .map(s => String(s.room||'').trim()))].sort();
          html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">ìƒë‹´ì‹¤</label>';
          html += '<select onchange="state.bookingForm.room=this.value; state.bookingForm.time=\'\'; render();" class="w-full p-3 border rounded-lg" required>';
          html += '<option value="">ì„ íƒ</option>';
          roomsForDate.forEach(r=>{
            html += '<option value="' + r + '" ' + (String(state.bookingForm.room||'').trim()===r?'selected':'') + '>' + r + '</option>';
          });
          html += '</select></div>';
        }

        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">' + (isTestOnly ? 'ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹œì‘ ì‹œê°„' : 'ìƒë‹´ ì‹œì‘ ì‹œê°„ (30ë¶„ ì†Œìš”)') + '</label>';
        
        const needRoom = (!isPhone && !isTestOnly && !state.bookingForm.room);
        const needTestRoom = (isTestOnly && !state.bookingForm.testRoom);

        if (needTestRoom) {
          html += '<p class="text-sm text-indigo-700 p-3 bg-indigo-50 rounded-lg">ë ˆë²¨í…ŒìŠ¤íŠ¸ ì¥ì†Œ(2ê´€/5ê´€)ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
        } else if (availableTimes.length > 0) {
          html += '<select onchange="state.bookingForm.time=this.value; render();" class="w-full p-3 border rounded-lg" required>';
          html += '<option value="">ì‹œê°„ ì„ íƒ</option>';
          availableTimes.forEach(time => {
            html += '<option value="' + time + '" ' + (state.bookingForm.time === time ? 'selected' : '') + '>' + time + ' (' + (isTestOnly?'ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹œì‘':'ìƒë‹´ ì‹œì‘') + ')</option>';
          });
          html += '</select>';
        } else {
          if (needRoom) {
            html += '<p class="text-sm text-red-500 p-3 bg-red-50 rounded-lg">ìƒë‹´ì‹¤ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
          } else {
            html += '<p class="text-sm text-red-500 p-3 bg-red-50 rounded-lg">ì„ íƒëœ ì¡°ê±´ì— ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          }
        }
        html += '</div>';

        if (state.bookingForm.time) {
          const g = String(state.bookingForm.grade || '').trim();
          const isElem = g.startsWith('elementary') || g === 'elementary' || ['ì´ˆ','ì´ˆ1','ì´ˆ2','ì´ˆ3','ì´ˆ4','ì´ˆ5','ì´ˆ6'].some(k => g.includes(k));
          
          if (isTestOnly) {
            const L = isElem ? 40 : 50;
            const consultStart = addMinutesToTime(state.bookingForm.time, L);
            const consultEnd = addMinutesToTime(consultStart, 30);
            html += '<div class="text-sm text-blue-700 p-3 bg-blue-100 rounded-lg">';
            html += 'ë ˆë²¨í…ŒìŠ¤íŠ¸: ' + state.bookingForm.time + ' - ' + consultStart + ' (' + L + 'ë¶„)<br>';
            html += 'ì „í™”ìƒë‹´: ' + consultStart + ' - ' + consultEnd + ' (30ë¶„)<br>';
            html += 'ì´ ì˜ˆì•½ ì‹œê°„: ' + state.bookingForm.time + ' - ' + consultEnd + ' (' + (L + 30) + 'ë¶„)';
            html += '</div>';
          } else if (state.bookingForm.hasLevelTest) {
            const levelTestMins = isElem ? 40 : 50;
            const testStart = addMinutesToTime(state.bookingForm.time, -levelTestMins);
            const consultEnd = addMinutesToTime(state.bookingForm.time, 30);
            html += '<div class="text-sm text-blue-700 p-3 bg-blue-100 rounded-lg">';
            html += 'ë ˆë²¨í…ŒìŠ¤íŠ¸: ' + testStart + ' - ' + state.bookingForm.time + ' (' + levelTestMins + 'ë¶„)<br>';
            html += 'ìƒë‹´: ' + state.bookingForm.time + ' - ' + consultEnd + ' (30ë¶„)<br>';
            html += 'ì´ ì˜ˆì•½ ì‹œê°„: ' + testStart + ' - ' + consultEnd + ' (' + (levelTestMins + 30) + 'ë¶„)';
            html += '</div>';
          } else {
            const consultEnd = addMinutesToTime(state.bookingForm.time, 30);
            html += '<div class="text-sm text-blue-700 p-3 bg-blue-100 rounded-lg">';
            html += 'ì´ ì˜ˆì•½ ì‹œê°„: ' + state.bookingForm.time + ' - ' + consultEnd + ' (30ë¶„' + (isPhone?' Â· ì „í™”ìƒë‹´':'') + ')';
            html += '</div>';
          }
        }
        
        html += '</div>';

        html += '<div class="flex justify-end gap-3 mt-8">';
        html += '<button type="button" onclick="state.showBookingForm=false; render();" class="px-4 py-2 rounded-lg border">ì·¨ì†Œ</button>';
        html += '<button type="button" onclick="addBooking()" class="px-4 py-2 rounded-lg bg-indigo-600 text-white shadow">' + (state.editingBooking ? 'ìˆ˜ì •' : 'ë“±ë¡') + '</button>';
        html += '</div>';
        html += '</div></div>';
      }

      if (state.showReasonModal) {
        const reasonOptions = [
          { value: 'ì…ë ¥ ì˜¤ë¥˜', label: 'ì˜ëª» ì…ë ¥ëœ ì˜ˆì•½' },
          { value: 'í•™ìƒ ë¶ˆì°¸', label: 'í•™ìƒ ë¶ˆì°¸ (ë…¸ì‡¼)' },
          { value: 'ì˜ˆì•½ ì·¨ì†Œ', label: 'ì‚¬ì „ ì˜ˆì•½ ì·¨ì†Œ' },
          { value: 'ê¸°íƒ€', label: 'ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)' }
        ];
        
        html += '<div class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="if(event.target.classList.contains(\'bg-opacity-75\')) { state.showReasonModal = false; render(); }">';
        html += '<div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">';
        html += '<h3 class="text-xl font-bold text-gray-800 mb-4">âŒ ë¯¸ì§„í–‰ ì‚¬ìœ  ì„ íƒ</h3>';
        
        html += '<div class="space-y-4">';
        html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">ì‚¬ìœ  ìœ í˜•</label>';
        html += '<select onchange="state.cancelReasonType = this.value; render();" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" required>';
        html += '<option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>';
        reasonOptions.forEach(opt => {
          html += '<option value="' + opt.value + '" ' + (state.cancelReasonType === opt.value ? 'selected' : '') + '>' + opt.label + '</option>';
        });
        html += '</select></div>';
        
        if (state.cancelReasonType === 'ê¸°íƒ€') {
          html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">ìƒì„¸ ì‚¬ìœ </label>';
          html += '<textarea oninput="state.cancelReason = this.value;" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" placeholder="ë¯¸ì§„í–‰ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." required>' + state.cancelReason + '</textarea></div>';
        }
        html += '</div>';

        html += '<div class="flex justify-end gap-3 mt-6">';
        html += '<button onclick="state.showReasonModal = false; state.selectedBookingId = null; state.cancelReason = \'\'; state.cancelReasonType = \'\'; render();" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition shadow-md">ì·¨ì†Œ</button>';
        const isDisabled = !state.cancelReasonType || (state.cancelReasonType === 'ê¸°íƒ€' && !state.cancelReason.trim());
        html += '<button onclick="submitCancelReason()" ' + (state.syncing || isDisabled ? 'disabled' : '') + ' class="px-4 py-2 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600 transition disabled:opacity-50 shadow-md">ë¯¸ì§„í–‰ ì²˜ë¦¬</button>';
        html += '</div>';
        html += '</div></div>';
      }

      if (state.showHistoryModal) {
        const historyBookings = state.bookings.filter(b => b.status !== 'scheduled').sort((a, b) => b.date.localeCompare(a.date) || b.time.localeCompare(a.time));

        html += '<div class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4" onclick="if(event.target.classList.contains(\'bg-opacity-75\')) { state.showHistoryModal = false; render(); }">';
        html += '<div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full h-3/4 flex flex-col p-6 md:p-8 transform transition-all scale-100">';
        html += '<h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“‹ ì§€ë‚œ ìƒë‹´ ë‚´ì—­ (' + historyBookings.length + 'ê±´)</h3>';
        
        html += '<div class="flex-1 overflow-y-auto space-y-3 pr-2">';
        
        if (historyBookings.length === 0) {
          html += '<p class="text-gray-500 text-center py-10">ì™„ë£Œë˜ê±°ë‚˜ ë¯¸ì§„í–‰ëœ ìƒë‹´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. (ìµœê·¼ 1ê°œì›”)</p>';
        } else {
          for (let booking of historyBookings) {
            const isCompleted = booking.status === 'completed';
            const statusClass = isCompleted ? 'border-green-400 bg-green-50' : 'border-red-400 bg-red-50';
            const statusText = isCompleted ? 'âœ“ ì™„ë£Œ' : 'âœ— ë¯¸ì§„í–‰';
            
            html += '<div class="border-l-4 ' + statusClass + ' p-3 rounded-lg shadow-sm">';
            html += '<div class="flex justify-between items-start">';
            html += '<div>';
            html += '<div class="text-sm font-semibold text-gray-800">' + booking.date + ' | ' + booking.room + ' | ' + gradeLabels[booking.grade] + ' ' + booking.studentName + '</div>';
            html += '<div class="text-xs text-gray-600 mt-1">ğŸ• ' + booking.time + ' - ' + booking.endTime + ' | ' + (booking.hasLevelTest ? 'ë ˆë²¨í…ŒìŠ¤íŠ¸ í¬í•¨' : 'ìƒë‹´ë§Œ') + '</div>';
            if (!isCompleted && booking.cancelReason) {
              html += '<p class="text-xs text-red-700 mt-2 p-1 bg-red-100 rounded">ì‚¬ìœ : ' + booking.cancelReason + '</p>';
            }
            html += '</div>';
            html += '<div class="text-sm font-bold ' + (isCompleted ? 'text-green-600' : 'text-red-600') + '">' + statusText + '</div>';
            html += '</div>';
            html += '</div>';
          }
        }
        
        html += '</div>';
        
        html += '<div class="flex justify-end mt-6">';
        html += '<button onclick="state.showHistoryModal = false; render();" class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600 transition shadow-md">ë‹«ê¸°</button>';
        html += '</div>';
        html += '</div></div>';
      }

      html += renderMessageBox();

      document.getElementById('app').innerHTML = html;
    }

    function renderMessageBox() {
      if (!msgState.show) return '';
      
      return `
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[99] flex items-center justify-center p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4">${msgState.type === 'alert' ? 'ì•Œë¦¼' : 'í™•ì¸'}</h3>
            <p class="text-gray-700 mb-6 whitespace-pre-line leading-relaxed">${msgState.message}</p>
            <div class="flex justify-end gap-3">
              ${msgState.type === 'confirm' ? `<button onclick="executeConfirm(false)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition shadow-md">ì·¨ì†Œ</button>` : ''}
              <button onclick="executeConfirm(true)" class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600 transition shadow-md">${msgState.type === 'alert' ? 'í™•ì¸' : 'ê³„ì†'}</button>
            </div>
          </div>
        </div>
      `;
    }

    window.onload = async function () {
      await loadFromGoogleSheets();
      const today = formatDate(new Date());
      handleDateClick(today, false);
    };

  </script>
</body>
</html>








