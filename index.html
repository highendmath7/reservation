<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>상담 예약 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
    * { font-family: 'Noto Sans KR', sans-serif; }
    .calendar-grid > div { text-align: center; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4 md:p-8">
  <div id="app" class="max-w-7xl mx-auto"></div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxDW-uVHGSJVQsP9xUtxGA4AzKESeJ-MbuBtV-jy8-8HJ6lqQZVlc4ukkMLvEb4wqw7-g/exec';
    
    let msgState = {
        show: false,
        type: 'alert',
        message: '',
        confirmCallback: null
    };

    function showCustomAlert(message) {
        msgState = { show: true, type: 'alert', message: message, confirmCallback: null };
        render();
    }

    function showCustomConfirm(message, callback) {
        msgState = { show: true, type: 'confirm', message: message, confirmCallback: callback };
        render();
    }

    function closeMessageBox() {
        msgState = { show: false, type: 'alert', message: '', confirmCallback: null };
        render();
    }

    function executeConfirm(result) {
        const callback = msgState.confirmCallback;
        closeMessageBox();
        if (result && callback) callback();
    }

    let state = {
      availableSlots: [],
      bookings: [],
      showSlotForm: false,
      showBookingForm: false,
      showHistoryModal: false,
      showReasonModal: false,
      editingSlot: null,
      editingBooking: null,
      currentDate: new Date(),
      selectedDate: null,
      loading: false,
      syncing: false,
      selectedBookingId: null,
      cancelReason: '',
      cancelReasonType: '',
      slotForm: { date: '', startTime: '', endTime: '', room: '' },
      bookingForm: {
        studentName: '',
        school: '',
        grade: 'elementary1',
        hasLevelTest: false,
        date: '',
        time: '',
        room: ''
      }
    };

    const gradeLabels = {
      elementary: '초등',
      middle: '중등',
      high: '고등',
      elementary1: '초1',
      elementary2: '초2',
      elementary3: '초3',
      elementary4: '초4',
      elementary5: '초5',
      elementary6: '초6',
      middle1: '중1',
      middle2: '중2',
      middle3: '중3',
      high1: '고1',
      high2: '고2',
      high3: '고3',
      unknown: '모름'
    };

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function getOneMonthAgo() {
      const date = new Date();
      date.setMonth(date.getMonth() - 1);
      return formatDate(date);
    }

   async function loadFromGoogleSheets() {
    state.loading = true;
    render();
  
    const oneMonthAgo = getOneMonthAgo();
    const toArray = (x) => Array.isArray(x)
      ? x
      : (Array.isArray(x?.bookings) ? x.bookings
      : (Array.isArray(x?.data) ? x.data : []));
    
    function toISODateStr(s) {
      if (!s) return '';
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0, 10);
    
      let m = s.match(/^\s*(\d{4})[.\-/]\s*(\d{1,2})[.\-/]\s*(\d{1,2})/);
      if (m) return `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
    
      m = s.match(/^\s*(\d{1,2})[.\-/]\s*(\d{1,2})[.\-/]\s*(\d{4})/);
      if (m) return `${m[3]}-${String(m[1]).padStart(2,'0')}-${String(m[2]).padStart(2,'0')}`;
    
      const d = new Date(s);
      if (!isNaN(d)) {
        const y = d.getFullYear();
        const m2 = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${y}-${m2}-${dd}`;
      }
      return '';
    }
    
    const isRecent = (d) => {
      const iso = toISODateStr(d);
      return iso && iso >= oneMonthAgo;
    };
  
    const normalizeSlot = (s) => ({
      ...s,
      date: toISODateStr((s?.date ?? '').toString().trim()),
      id: s?.id ?? '',
    });
  
    const normalizeBooking = (b) => {
      const rawGrade = (b?.grade ?? '').toString().trim();
      return {
        ...b,
        id: b?.id ?? '',
        date: toISODateStr((b?.date ?? '').toString().trim()),
        time: b?.time ?? b?.startTime ?? '',
        endTime: b?.endTime ?? '',
        room: b?.room ?? '',
        consultTime: b?.consultTime ?? '',
        status: b?.status ?? 'scheduled',
        cancelReason: b?.cancelReason ?? '',
        completedAt: b?.completedAt ?? '',
        grade: rawGrade,
        studentName: b?.studentName ?? '',
        school: b?.school ?? '모름',
        hasLevelTest: b?.hasLevelTest ?? false,
        _isElementary:
          rawGrade.startsWith('elementary') ||
          rawGrade === 'elementary' ||
          ['초','초1','초2','초3','초4','초5','초6'].some(k => rawGrade.includes(k)),
      };
    };
  
    try {
      const slotsResponse = await fetch(`${GOOGLE_SCRIPT_URL}?sheet=slots&ts=${Date.now()}`, {cache: 'no-store'});
      const slotsRaw = await slotsResponse.json();
      const slotsArr = toArray(slotsRaw).map(normalizeSlot);
      state.availableSlots = slotsArr.filter(s => s.id && isRecent(s.date));
  
      const bookingsResponse = await fetch(`${GOOGLE_SCRIPT_URL}?sheet=bookings&ts=${Date.now()}`, {cache: 'no-store'});
      const bookingsRaw = await bookingsResponse.json();
      const bookingsArr = toArray(bookingsRaw).map(normalizeBooking);
      state.bookings = bookingsArr.filter(b => b.id && isRecent(b.date));
  
      state.bookings.sort((a, b) => (a.date + a.time + a.room).localeCompare(b.date + b.time + b.room));
  
      try { await cleanupOldData(oneMonthAgo); } catch (e) { console.warn('cleanupOldData failed:', e); }
    } catch (err) {
      console.error('loadFromGoogleSheets error:', err);
      state.availableSlots = state.availableSlots || [];
      state.bookings = state.bookings || [];
    } finally {
      state.loading = false;
      if (!state.selectedDate) {
        state.selectedDate = formatDate(new Date());
      }
      render();
    }
  }

    async function cleanupOldData(cutoffDate) {
      try {
        const oldSlots = (state.availableSlots || []).filter(slot => slot.date < cutoffDate && slot.id);
        const oldBookings = (state.bookings || []).filter(booking => booking.date < cutoffDate && booking.id);
        
        for (let slot of oldSlots) {
          await deleteFromGoogleSheets('slots', slot.id);
        }
        
        for (let booking of oldBookings) {
          await deleteFromGoogleSheets('bookings', booking.id);
        }
        
        if (oldSlots.length > 0 || oldBookings.length > 0) {
          console.log('1달 이전 데이터 삭제 완료');
        }
      } catch (error) {
        console.error('데이터 정리 실패:', error);
      }
    }

    async function addToGoogleSheets(sheet, data) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'add');
      formData.append('data', JSON.stringify(data));
      await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
      await loadFromGoogleSheets();
      handleDateClick(state.selectedDate, false);
    }

    async function updateInGoogleSheets(sheet, id, data) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'update');
      formData.append('id', id);
      formData.append('data', JSON.stringify(data));
      await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
      await loadFromGoogleSheets();
      handleDateClick(state.selectedDate, false);
    }

    async function deleteFromGoogleSheets(sheet, id) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'delete');
      formData.append('id', id);
      await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
      await loadFromGoogleSheets();
      handleDateClick(state.selectedDate, false);
    }

    function timeToMins(time) {
      if (!time) return 0;
      const [h, m] = time.split(':').map(Number);
      return h * 60 + m;
    }

    function minsToTime(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    }

    function addMinutesToTime(time, minutes) {
      return minsToTime(timeToMins(time) + minutes);
    }

    function isWeekend(dateStr) {
      const date = new Date(dateStr);
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    function openSlotForm(date) {
      const allRooms = [...new Set(state.availableSlots.map(s => s.room))].sort();
      const availableRoomsForDate = [...new Set(state.availableSlots.filter(s => s.date === date).map(s => s.room))].sort();
      state.slotForm.date = date;
      state.slotForm.room = availableRoomsForDate[0] || allRooms[0] || '';
      state.showSlotForm = true;
      render();
    }

    async function addSlot() {
      if (!state.slotForm.date || !state.slotForm.startTime || !state.slotForm.endTime || !state.slotForm.room) {
        showCustomAlert('모든 필드를 입력해주세요.');
        return;
      }
      
      if (timeToMins(state.slotForm.startTime) >= timeToMins(state.slotForm.endTime)) {
        showCustomAlert('종료 시간이 시작 시간보다 늦어야 합니다.');
        return;
      }

      state.syncing = true;
      render();
      
      try {
        const newSlot = {
          id: Date.now().toString(),
          date: state.slotForm.date,
          startTime: state.slotForm.startTime,
          endTime: state.slotForm.endTime,
          room: state.slotForm.room
        };
        await addToGoogleSheets('slots', newSlot);
        state.availableSlots.push(newSlot);
        
        state.slotForm = { date: '', startTime: '', endTime: '', room: '' };
        state.showSlotForm = false;
        showCustomAlert('저장되었습니다!');
      } catch (error) {
        console.error('에러:', error);
        showCustomAlert('저장 실패!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    function openBookingForm(bookingId = null) {
      if (bookingId) {
        const booking = state.bookings.find(b => b.id === bookingId);
        if (!booking) return;
        
        state.editingBooking = bookingId;
        
        const timeValue = booking.hasLevelTest 
          ? booking.time
          : (booking.consultTime || booking.time);
        
        state.bookingForm = {
          studentName: booking.studentName,
          school: booking.school,
          grade: booking.grade,
          hasLevelTest: booking.hasLevelTest,
          date: booking.date,
          time: timeValue,
          room: booking.room
        };
      } else {
        state.editingBooking = null;
      }
      
      state.showBookingForm = true;
      render();
    }

    async function addBooking() {
      if (!state.bookingForm.studentName || !state.bookingForm.date || 
          !state.bookingForm.time || !state.bookingForm.room) {
        showCustomAlert('모든 필드를 입력해주세요.');
        return;
      }
      
      if (state.bookingForm.hasLevelTest && state.bookingForm.grade === 'unknown') {
        showCustomAlert('학년을 모르는 경우 레벨테스트 시간을 정확히 계산할 수 없습니다. 학년을 선택하거나 레벨테스트 옵션을 해제해주세요.');
        return;
      }
      
      const g = String(state.bookingForm.grade || '').trim();
      const isElementary =
        g.startsWith('elementary') ||
        g === 'elementary' ||
        ['초', '초1','초2','초3','초4','초5','초6'].some(k => g.includes(k));
      
      const levelTestMins = state.bookingForm.hasLevelTest ? (isElementary ? 40 : 50) : 0;
      
      const levelTestStartTime = state.bookingForm.time;
      const consultTime = state.bookingForm.hasLevelTest 
        ? addMinutesToTime(levelTestStartTime, levelTestMins)
        : levelTestStartTime;
      const consultEndTime = addMinutesToTime(consultTime, 30);
      
      const startTime = levelTestStartTime;
      const endTime = consultEndTime;
      
      const hasConflict = state.bookings.some(booking => {
        if (state.editingBooking && booking.id === state.editingBooking) return false;
        
        if (booking.date !== state.bookingForm.date || 
            booking.room !== state.bookingForm.room) return false;
        if (booking.status === 'cancelled') return false;
        
        const existingStart = timeToMins(booking.time);
        const existingEnd = timeToMins(booking.endTime);
        const newStart = timeToMins(startTime);
        const newEnd = timeToMins(endTime);
        
        return !(newEnd <= existingStart || newStart >= existingEnd);
      });
      
      if (hasConflict) {
        showCustomAlert('선택한 시간에 다른 예약과 겹칩니다.');
        return;
      }

      const slotOverlap = state.availableSlots.some(slot => {
        if (slot.date !== state.bookingForm.date || 
            slot.room !== state.bookingForm.room) return false;
        
        const slotStart = timeToMins(slot.startTime);
        const slotEnd = timeToMins(slot.endTime);
        const consultStartMins = timeToMins(consultTime);
        const consultEndMins = timeToMins(consultEndTime);
        
        return (consultStartMins >= slotStart && consultEndMins <= slotEnd);
      });

      if (!slotOverlap) {
        showCustomAlert('상담 시간이 상담 가능 시간을 벗어납니다.');
        return;
      }
      
      state.syncing = true;
      render();
      
      try {
        const bookingData = {
          studentName: state.bookingForm.studentName,
          school: state.bookingForm.school || '모름',
          grade: state.bookingForm.grade,
          hasLevelTest: state.bookingForm.hasLevelTest,
          date: state.bookingForm.date,
          time: startTime,
          endTime: endTime,
          room: state.bookingForm.room,
          consultTime: consultTime,
          status: 'scheduled'
        };

        if (state.editingBooking) {
          const existingBooking = state.bookings.find(b => b.id === state.editingBooking);
          await updateInGoogleSheets('bookings', state.editingBooking, {
            ...existingBooking,
            ...bookingData
          });
          const index = state.bookings.findIndex(b => b.id === state.editingBooking);
          state.bookings[index] = { ...existingBooking, ...bookingData };
          showCustomAlert('예약이 수정되었습니다!');
        } else {
          const newBooking = {
            id: Date.now().toString(),
            ...bookingData
          };
          await addToGoogleSheets('bookings', newBooking);
          state.bookings.push(newBooking);
          showCustomAlert('예약이 등록되었습니다!');
        }
        
        state.bookingForm = {
          studentName: '',
          school: '',
          grade: 'elementary1',
          hasLevelTest: false,
          date: state.bookingForm.date,
          time: '',
          room: state.bookingForm.room
        };
        state.editingBooking = null;
        state.showBookingForm = false;
        render();
      } catch (error) {
        console.error('에러:', error);
        showCustomAlert('예약 처리 실패!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    async function updateBookingStatus(id, status, reason = '') {
      state.syncing = true;
      render();
      
      try {
        const booking = state.bookings.find(b => b.id === id);
        if (!booking) return;
        
        const updatedBooking = {
          ...booking,
          status: status,
          cancelReason: reason || '',
          completedAt: status === 'completed' ? new Date().toISOString() : booking.completedAt
        };
        
        await updateInGoogleSheets('bookings', id, updatedBooking);
        
        const index = state.bookings.findIndex(b => b.id === id);
        state.bookings[index] = updatedBooking;
        
        showCustomAlert(status === 'completed' ? '완료 처리되었습니다!' : '미진행 처리되었습니다!');
      } catch (error) {
        console.error('에러:', error);
        showCustomAlert('상태 변경 실패!');
      } finally {
        state.syncing = false;
        state.showReasonModal = false;
        state.selectedBookingId = null;
        state.cancelReason = '';
        state.cancelReasonType = '';
        render();
      }
    }

    function openReasonModal(id) {
      state.selectedBookingId = id;
      state.showReasonModal = true;
      state.cancelReason = '';
      state.cancelReasonType = '';
      render();
    }

    function submitCancelReason() {
      if (!state.cancelReasonType) {
        showCustomAlert('미진행 사유를 선택해주세요.');
        return;
      }
      if (state.cancelReasonType === '기타' && !state.cancelReason.trim()) {
        showCustomAlert('기타 사유를 입력해주세요.');
        return;
      }
      const finalReason = state.cancelReasonType === '기타' ? state.cancelReason : state.cancelReasonType;
      updateBookingStatus(state.selectedBookingId, 'cancelled', finalReason);
    }

    async function deleteSlot(id) {
      showCustomConfirm('정말 삭제하시겠습니까? 이 시간대에 예약된 상담이 있는지 확인해주세요.', async () => {
        state.syncing = true;
        render();
        
        try {
          await deleteFromGoogleSheets('slots', id);
          state.availableSlots = state.availableSlots.filter(s => s.id !== id);
          showCustomAlert('삭제되었습니다!');
        } catch (error) {
          showCustomAlert('삭제 실패!');
        } finally {
          state.syncing = false;
          render();
        }
      });
    }

    async function deleteBooking(id) {
      showCustomConfirm('정말 이 예약을 삭제하시겠습니까?', async () => {
        state.syncing = true;
        render();
        
        try {
          await deleteFromGoogleSheets('bookings', id);
          state.bookings = state.bookings.filter(b => b.id !== id);
          showCustomAlert('삭제되었습니다!');
        } catch (error) {
          showCustomAlert('삭제 실패!');
        } finally {
          state.syncing = false;
          render();
        }
      });
    }

    function prevMonth() {
      state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() - 1, 1);
      render();
    }

    function nextMonth() {
      state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1, 1);
      render();
    }

    function renderCalendar() {
      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      const today = formatDate(new Date());
      const oneMonthAgo = getOneMonthAgo();
      
      let html = '';
      
      for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="h-20"></div>';
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = formatDate(date);
        const hasSlots = state.availableSlots.some(slot => slot.date === dateStr);
        const hasBooking = state.bookings.some(booking => booking.date === dateStr);
        const isSelected = state.selectedDate === dateStr;
        const isToday = dateStr === today;
        const isPast = dateStr < today;
        const isTooOld = dateStr < oneMonthAgo;
        
        let classes = 'h-20 border p-2 transition rounded-lg overflow-hidden ';
        if (isTooOld) {
          classes += 'bg-gray-100 opacity-50 text-gray-400 cursor-default';
        } else if (isPast) {
          classes += 'bg-gray-200 cursor-pointer opacity-70';
        } else if (isSelected) {
          classes += 'bg-indigo-200 border-indigo-600 ring-2 ring-indigo-400 cursor-pointer shadow-md';
        } else if (hasSlots || hasBooking) {
          classes += 'bg-white hover:bg-green-100 cursor-pointer shadow-sm border-gray-200';
        } else {
          classes += 'bg-white hover:bg-gray-50 cursor-pointer shadow-sm border-gray-200';
        }
        if (isToday) classes += ' ring-2 ring-blue-500 ring-offset-2';
        
        html += '<div class="' + classes + '" onclick="handleDateClick(\'' + dateStr + '\', ' + (isPast && !isTooOld) + ')">';
        html += '<div class="font-semibold text-sm ' + (isPast ? 'text-gray-500' : 'text-gray-800') + '">' + day + '</div>';
        html += '<div class="flex justify-center gap-1 mt-1">';
        if (hasSlots) {
          html += '<div title="상담 가능" class="w-3 h-3 bg-green-500 rounded-full"></div>';
        }
        if (hasBooking) {
          html += '<div title="예약 있음" class="w-3 h-3 bg-blue-500 rounded-full"></div>';
        }
        html += '</div></div>';
      }
      
      return html;
    }

    function handleDateClick(dateStr, isPast) {
      state.selectedDate = dateStr;
      if (!isPast) {
        state.bookingForm.date = dateStr;
      }
      render();
    }

    function generateTimeOptions(dateStr) {
      const options = [];
      const weekend = isWeekend(dateStr);
      const startHour = weekend ? 10 : 15;
      const endHour = 22;
      
      for (let h = startHour; h <= endHour; h++) {
        for (let m = 0; m < 60; m += 5) {
          const time = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
          options.push(time);
        }
      }
      return options;
    }
    
   function getAvailableConsultTimes() {
    if (!state.bookingForm.date || !state.bookingForm.room) return [];
  
    const slots = (state.availableSlots || []).filter(
      s => (s.date || '').trim().startsWith(state.bookingForm.date) &&
           (s.room || '').trim() === (state.bookingForm.room || '').trim()
    );
    if (slots.length === 0) return [];
  
    const g = String(state.bookingForm.grade || '').trim();
    const isElementary = g.startsWith('elementary') || g === 'elementary' ||
                         ['초','초1','초2','초3','초4','초5','초6'].some(k => g.includes(k));
    const CONSULT_DURATION = 30;
    const levelTestMins = state.bookingForm.hasLevelTest ? (isElementary ? 40 : 50) : 0;
  
    const normalizedBookings = (state.bookings || [])
      .filter(b => {
        if (state.editingBooking && b.id === state.editingBooking) return false;
        return (b.date || '').trim().startsWith(state.bookingForm.date) &&
               (b.room || '').trim() === (state.bookingForm.room || '').trim() &&
               (b.status || 'scheduled') !== 'cancelled';
      })
      .map(b => {
        const timeStr = (b.time || '').trim();
        const endStr = (b.endTime || '').trim();
        const startM = timeToMins(timeStr);
        const endM = timeToMins(endStr);
        return { startM, endM };
      })
      .filter(x => Number.isFinite(x.startM) && Number.isFinite(x.endM) && x.endM > x.startM);
  
    const availableTimes = new Set();
    const step = 5;
  
    for (const slot of slots) {
      const slotStartM = timeToMins(slot.startTime || slot.time);
      const slotEndM = timeToMins(slot.endTime);
      if (!Number.isFinite(slotStartM) || !Number.isFinite(slotEndM) || slotEndM <= slotStartM) continue;
  
      for (let levelTestStartM = slotStartM - levelTestMins;
           levelTestStartM <= slotEndM - levelTestMins - CONSULT_DURATION;
           levelTestStartM += step) {

        const consultStartM = levelTestStartM + levelTestMins;
        const consultEndM = consultStartM + CONSULT_DURATION;

        if (consultStartM < slotStartM || consultEndM > slotEndM) continue;

        const newStart = levelTestStartM;
        const newEnd = consultEndM;

        let conflict = false;
        for (const r of normalizedBookings) {
          if (!(newEnd <= r.startM || newStart >= r.endM)) {
            conflict = true;
            break;
          }
        }
        if (!conflict) {
          availableTimes.add(minsToTime(levelTestStartM));
        }
      }
    }

    return Array.from(availableTimes).sort();
  }

    function render() {
      const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
      const selectedSlots = state.availableSlots.filter(s => s.date === state.selectedDate);
      const selectedBookings = state.bookings
        .filter(b => (b.date || '').startsWith(state.selectedDate))
        .sort((a, b) => a.time.localeCompare(b.time));
      const today = formatDate(new Date());
      const bookings = state.bookings || [];
      const todayBookings = bookings
        .filter(b => (b.date || '').startsWith(today))
        .sort((a, b) => a.time.localeCompare(b.time));
      
      let html = '<div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">';
      html += '<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">';
      html += '<h1 class="text-3xl font-extrabold text-gray-800">📅 상담 예약 시스템</h1>';
      html += '<div class="flex gap-2">';
      html += '<button onclick="state.showHistoryModal = true; render();" class="bg-purple-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-purple-600 transition shadow-md">📋 지난 내역</button>';
      html += '<button onclick="loadFromGoogleSheets()" ' + (state.loading || state.syncing ? 'disabled' : '') + ' class="bg-green-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-green-600 transition disabled:opacity-50 shadow-md">';
      html += '🔄 ' + (state.loading ? '로딩중...' : state.syncing ? '동기화중...' : '새로고침');
      html += '</button></div></div>';

      if (state.loading) {
        html += '<div class="text-center py-20">';
        html += '<div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>';
        html += '<p class="mt-4 text-gray-600">데이터를 불러오는 중...</p>';
        html += '</div>';
      } else {
        html += '<div class="mb-8 bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200 shadow-lg">';
        html += '<h2 class="text-2xl font-bold text-gray-800 mb-4">🔔 오늘의 상담 예약 (' + today + ')</h2>';
        
        if (todayBookings.length === 0) {
          html += '<p class="text-gray-500 text-center py-8">오늘 예약된 상담이 없습니다.</p>';
        } else {
          html += '<div class="space-y-3">';
          for (let booking of todayBookings) {
            const statusColor = booking.status === 'completed' ? 'bg-green-100 border-green-400' : 
                               booking.status === 'cancelled' ? 'bg-red-100 border-red-400' : 
                               'bg-white border-blue-400';
            const statusText = booking.status === 'completed' ? '✓ 완료' : booking.status === 'cancelled' ? '✗ 미진행' : '⏳ 예정';
            
            html += '<div class="' + statusColor + ' border-2 p-4 rounded-xl flex justify-between items-center shadow-md">';
            html += '<div class="flex-1">';
            html += '<div class="text-lg font-semibold text-gray-800 mb-1">';
            html += '<span class="text-indigo-600">' + booking.room + '</span> | ';
            html += booking.school + ' ' + gradeLabels[booking.grade] + ' | ';
            html += '<span class="text-blue-700">' + booking.studentName + '</span>';
            html += ' <span class="text-sm font-medium ' + (booking.status === 'completed' ? 'text-green-600' : booking.status === 'cancelled' ? 'text-red-600' : 'text-orange-600') + '">' + statusText + '</span>';
            html += '</div>';
            html += '<div class="flex items-center gap-4 text-gray-600 text-sm">';
            html += '<span class="font-medium">🕐 ' + booking.time + ' - ' + booking.endTime + '</span>';
            html += '<span class="text-indigo-600 font-medium">' + (booking.hasLevelTest ? '레벨테스트 + 상담' : '상담') + '</span>';
            html += '</div>';
            if (booking.hasLevelTest) {
              html += '<p class="text-xs text-gray-500 mt-1">상담 시작 시간: ' + booking.consultTime + '</p>';
            }
            if (booking.status === 'cancelled' && booking.cancelReason) {
              html += '<p class="text-sm text-red-700 mt-2 bg-red-50 p-2 rounded-lg border border-red-200">미진행 사유: ' + booking.cancelReason + '</p>';
            }
            html += '</div>';
            
            if (booking.status === 'scheduled') {
              html += '<div class="flex flex-col gap-2 ml-4">';
              html += '<button onclick="updateBookingStatus(\'' + booking.id + '\', \'completed\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 disabled:opacity-50 shadow-md">✓ 완료</button>';
              html += '<button onclick="openReasonModal(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-orange-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-orange-600 disabled:opacity-50 shadow-md">✗ 미진행</button>';
              html += '</div>';
            }
            
            html += '</div>';
          }
          html += '</div>';
        }
        html += '</div>';

        html += '<div class="mb-8">';
        html += '<div class="flex justify-between items-center mb-4">';
        html += '<h2 class="text-2xl font-bold text-gray-800">📅 캘린더</h2>';
        html += '<div class="flex items-center gap-4">';
        html += '<button onclick="prevMonth()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full transition">◀</button>';
        html += '<span class="text-xl font-bold text-indigo-700">' + state.currentDate.getFullYear() + '년 ' + monthNames[state.currentDate.getMonth()] + '</span>';
        html += '<button onclick="nextMonth()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full transition">▶</button>';
        html += '</div></div>';
        
        html += '<div class="mb-4 flex gap-4 text-sm text-gray-600 justify-center">';
        html += '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-green-500 rounded-full"></div><span>상담 가능 시간</span></div>';
        html += '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-blue-500 rounded-full"></div><span>예약된 상담</span></div>';
        html += '</div>';

        html += '<div class="grid grid-cols-7 gap-1 mb-2 calendar-grid">';
        const days = ['일', '월', '화', '수', '목', '금', '토'];
        for (let i = 0; i < days.length; i++) {
          const dayClass = i === 0 ? 'text-red-500' : i === 6 ? 'text-blue-500' : 'text-gray-600';
          html += '<div class="text-center font-bold p-2 ' + dayClass + '">' + days[i] + '</div>';
        }
        html += '</div>';
        
        html += '<div class="grid grid-cols-7 gap-1 calendar-grid">';
        html += renderCalendar();
        html += '</div></div>';

        if (state.selectedDate) {
          const isPastDate = state.selectedDate < today;
          html += '<div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200 space-y-8">';
          html += '<div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">' + state.selectedDate + ' 상세 정보</h2>';
          html += '<button onclick="state.selectedDate = null; render();" class="text-gray-500 hover:text-gray-800 text-sm">X 닫기</button></div>';

          html += '<div><div class="flex justify-between items-center mb-3">';
          html += '<h3 class="font-semibold text-xl text-gray-800">🗓️ 상담 가능 시간</h3>';
          if (!isPastDate) {
            html += '<button onclick="openSlotForm(\'' + state.selectedDate + '\')" class="bg-indigo-600 text-white px-3 py-1 rounded-xl text-sm font-semibold hover:bg-indigo-700 shadow-md transition">+ 시간 추가</button>';
          }
          html += '</div><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">';
          
          if (selectedSlots.length === 0) {
            html += '<p class="text-gray-500 text-sm py-4">이 날짜에 설정된 상담 가능 시간이 없습니다.</p>';
          } else {
            for (let slot of selectedSlots) {
              html += '<div class="bg-green-50 p-3 rounded-xl border border-green-300 flex justify-between items-center shadow-sm">';
              html += '<div><div class="font-medium text-green-700">' + slot.room + '</div>';
              html += '<div class="text-base font-bold text-gray-800">' + slot.startTime + ' - ' + slot.endTime + '</div></div>';
              if (!isPastDate) {
                html += '<button onclick="deleteSlot(\'' + slot.id + '\')" class="text-red-500 hover:text-red-700 p-1 text-lg">🗑️</button>';
              }
              html += '</div>';
            }
          }
          html += '</div></div>';

          html += '<div><div class="flex justify-between items-center mb-3">';
          html += '<h3 class="font-semibold text-xl text-gray-800">👥 예약 현황</h3>';
          if (!isPastDate && selectedSlots.length > 0) {
            html += '<button onclick="openBookingForm()" class="bg-blue-600 text-white px-3 py-1 rounded-xl text-sm font-semibold hover:bg-blue-700 shadow-md transition">+ 신규 예약</button>';
          }
          html += '</div><div class="space-y-3">';
          
          if (selectedBookings.length === 0) {
            html += '<p class="text-gray-500 text-sm py-4">이 날짜에 예약된 상담이 없습니다.</p>';
          } else {
            for (let booking of selectedBookings) {
              const statusColor = booking.status === 'completed' ? 'bg-green-50 border-green-300' : 
                                  booking.status === 'cancelled' ? 'bg-red-50 border-red-300' : 
                                  'bg-blue-50 border-blue-300';
              const statusText = booking.status === 'completed' ? '✓ 완료' : booking.status === 'cancelled' ? '✗ 미진행' : '⏳ 예정';
              
              html += '<div class="' + statusColor + ' p-4 rounded-xl border flex justify-between items-start shadow-sm">';
              html += '<div class="flex-1">';
              html += '<div class="text-lg font-bold text-gray-800">';
              html += '<span class="text-indigo-600">' + booking.room + '</span> | ';
              html += '<span class="text-gray-700">' + gradeLabels[booking.grade] + ' ' + booking.studentName + '</span>';
              html += ' <span class="text-sm font-medium ' + (booking.status === 'completed' ? 'text-green-600' : booking.status === 'cancelled' ? 'text-red-600' : 'text-orange-600') + '">' + statusText + '</span>';
              html += '</div>';
              html += '<div class="text-sm text-gray-600 mt-1">';
              html += '<span>🕐 ' + booking.time + ' - ' + booking.endTime + '</span>';
              html += '<span class="mx-2">|</span>';
              html += '<span class="text-indigo-600 font-medium">' + (booking.hasLevelTest ? '레벨테스트 + 상담' : '상담') + '</span>';
              html += '<span class="mx-2">|</span>';
              html += '<span class="text-gray-500">학교: ' + booking.school + '</span>';
              html += '</div>';

              if (booking.hasLevelTest) {
                html += '<p class="text-xs text-gray-500 mt-1">상담 시작: ' + booking.consultTime + ' / 테스트 시작: ' + booking.time + '</p>';
              }
              if (booking.status === 'cancelled' && booking.cancelReason) {
                html += '<p class="text-sm text-red-700 mt-2 bg-red-100 p-2 rounded-lg border border-red-300">미진행 사유: ' + booking.cancelReason + '</p>';
              }
              html += '</div>';

              html += '<div class="flex flex-col gap-1 ml-4">';
              if (booking.status === 'scheduled') {
                html += '<button onclick="openBookingForm(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-blue-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-blue-600 disabled:opacity-50 shadow-sm">✏️ 수정</button>';
                html += '<button onclick="updateBookingStatus(\'' + booking.id + '\', \'completed\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-green-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-green-600 disabled:opacity-50 shadow-sm">✓ 완료</button>';
                html += '<button onclick="openReasonModal(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-orange-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-orange-600 disabled:opacity-50 shadow-sm">✗ 미진행</button>';
              }
              html += '<button onclick="deleteBooking(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-red-50 text-red-700 border border-red-300 px-3 py-1 rounded-lg text-xs hover:bg-red-100 disabled:opacity-50 shadow-sm">삭제</button>';
              html += '</div></div>';
            }
          }
          html += '</div></div>';
          html += '</div>';
        }
      }
      
      html += '</div>';

      if (state.showSlotForm) {
        const timeOptions = generateTimeOptions(state.slotForm.date);
        
        html += '<div class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="if(event.target.classList.contains(\'bg-opacity-75\')) { state.showReasonModal = false; render(); }">';
        html += '<div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">';
        html += '<h3 class="text-xl font-bold text-gray-800 mb-4">⌫ 미진행 사유 선택</h3>';
        
        html += '<div class="space-y-4">';
        html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">사유 유형</label>';
        html += '<select onchange="state.cancelReasonType = this.value; render();" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" required>';
        html += '<option value="">선택해주세요</option>';
        reasonOptions.forEach(opt => {
          html += '<option value="' + opt.value + '" ' + (state.cancelReasonType === opt.value ? 'selected' : '') + '>' + opt.label + '</option>';
        });
        html += '</select></div>';
        
        if (state.cancelReasonType === '기타') {
          html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">상세 사유</label>';
          html += '<textarea oninput="state.cancelReason = this.value;" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" placeholder="미진행 사유를 입력해주세요." required>' + state.cancelReason + '</textarea></div>';
        }
        html += '</div>';

        html += '<div class="flex justify-end gap-3 mt-6">';
        html += '<button onclick="state.showReasonModal = false; state.selectedBookingId = null; state.cancelReason = \'\'; state.cancelReasonType = \'\'; render();" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition shadow-md">취소</button>';
        const isDisabled = !state.cancelReasonType || (state.cancelReasonType === '기타' && !state.cancelReason.trim());
        html += '<button onclick="submitCancelReason()" ' + (state.syncing || isDisabled ? 'disabled' : '') + ' class="px-4 py-2 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600 transition disabled:opacity-50 shadow-md">미진행 처리</button>';
        html += '</div>';
        html += '</div></div>';
      }

      if (state.showHistoryModal) {
        const historyBookings = state.bookings.filter(b => b.status !== 'scheduled').sort((a, b) => b.date.localeCompare(a.date) || b.time.localeCompare(a.time));

        html += '<div class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4" onclick="if(event.target.classList.contains(\'bg-opacity-75\')) { state.showHistoryModal = false; render(); }">';
        html += '<div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full h-3/4 flex flex-col p-6 md:p-8 transform transition-all scale-100">';
        html += '<h3 class="text-2xl font-bold text-gray-800 mb-4">📋 지난 상담 내역 (' + historyBookings.length + '건)</h3>';
        
        html += '<div class="flex-1 overflow-y-auto space-y-3 pr-2">';
        
        if (historyBookings.length === 0) {
          html += '<p class="text-gray-500 text-center py-10">완료되거나 미진행된 상담 내역이 없습니다. (최근 1개월)</p>';
        } else {
          for (let booking of historyBookings) {
            const isCompleted = booking.status === 'completed';
            const statusClass = isCompleted ? 'border-green-400 bg-green-50' : 'border-red-400 bg-red-50';
            const statusText = isCompleted ? '✓ 완료' : '✗ 미진행';
            
            html += '<div class="border-l-4 ' + statusClass + ' p-3 rounded-lg shadow-sm">';
            html += '<div class="flex justify-between items-start">';
            html += '<div>';
            html += '<div class="text-sm font-semibold text-gray-800">' + booking.date + ' | ' + booking.room + ' | ' + gradeLabels[booking.grade] + ' ' + booking.studentName + '</div>';
            html += '<div class="text-xs text-gray-600 mt-1">🕐 ' + booking.time + ' - ' + booking.endTime + ' | ' + (booking.hasLevelTest ? '레벨테스트 포함' : '상담만') + '</div>';
            if (!isCompleted && booking.cancelReason) {
              html += '<p class="text-xs text-red-700 mt-2 p-1 bg-red-100 rounded">사유: ' + booking.cancelReason + '</p>';
            }
            html += '</div>';
            html += '<div class="text-sm font-bold ' + (isCompleted ? 'text-green-600' : 'text-red-600') + '">' + statusText + '</div>';
            html += '</div>';
            html += '</div>';
          }
        }
        
        html += '</div>';
        
        html += '<div class="flex justify-end mt-6">';
        html += '<button onclick="state.showHistoryModal = false; render();" class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600 transition shadow-md">닫기</button>';
        html += '</div>';
        html += '</div></div>';
      }

      html += renderMessageBox();

      document.getElementById('app').innerHTML = html;
    }

    function renderMessageBox() {
      if (!msgState.show) return '';
      
      return `
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[99] flex items-center justify-center p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4">${msgState.type === 'alert' ? '알림' : '확인'}</h3>
            <p class="text-gray-700 mb-6">${msgState.message}</p>
            <div class="flex justify-end gap-3">
              ${msgState.type === 'confirm' ? `<button onclick="executeConfirm(false)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition shadow-md">취소</button>` : ''}
              <button onclick="executeConfirm(true)" class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600 transition shadow-md">${msgState.type === 'alert' ? '확인' : '계속'}</button>
            </div>
          </div>
        </div>
      `;
    }

    window.onload = async function () {
      await loadFromGoogleSheets();
      const today = formatDate(new Date());
      handleDateClick(today, false);
    };

  </script>
</body>
</html>bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4" onclick="if(event.target.classList.contains(\'bg-opacity-75\')) { state.showSlotForm = false; render(); }">';
        html += '<div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 md:p-8 transform transition-all scale-100">';
        html += '<h3 class="text-2xl font-bold text-gray-800 mb-6">➕ 상담 가능 시간 추가</h3>';
        
        html += '<div class="space-y-4">';
        
        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">날짜</label>';
        html += '<input type="date" value="' + state.slotForm.date + '" onchange="state.slotForm.date = this.value; render();" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required></div>';

        if (state.slotForm.date) {
          const isWeekendDate = isWeekend(state.slotForm.date);
          html += '<div class="text-sm p-3 rounded-lg ' + (isWeekendDate ? 'bg-blue-50 text-blue-700' : 'bg-green-50 text-green-700') + '">';
          html += isWeekendDate ? '📅 주말: 10:00~22:00 사이 선택 가능' : '📅 주중: 15:00~22:00 사이 선택 가능';
          html += '</div>';
        }

        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">상담실</label>';
        html += '<input type="text" value="' + state.slotForm.room + '" oninput="state.slotForm.room = this.value;" placeholder="예: 1관, 2관, 본관" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required></div>';

        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">시작 시간 (24시간 표기)</label>';
        html += '<select onchange="state.slotForm.startTime = this.value; render();" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>';
        html += '<option value="">선택</option>';
        timeOptions.forEach(time => {
          html += '<option value="' + time + '" ' + (state.slotForm.startTime === time ? 'selected' : '') + '>' + time + '</option>';
        });
        html += '</select></div>';

        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">종료 시간 (24시간 표기)</label>';
        html += '<select onchange="state.slotForm.endTime = this.value; render();" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>';
        html += '<option value="">선택</option>';
        timeOptions.forEach(time => {
          html += '<option value="' + time + '" ' + (state.slotForm.endTime === time ? 'selected' : '') + '>' + time + '</option>';
        });
        html += '</select></div>';
        
        html += '</div>';

        html += '<div class="flex justify-end gap-3 mt-8">';
        html += '<button onclick="state.showSlotForm = false; render();" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition shadow-md">취소</button>';
        html += '<button onclick="addSlot()" ' + (state.syncing ? 'disabled' : '') + ' class="px-4 py-2 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600 transition disabled:opacity-50 shadow-md">저장</button>';
        html += '</div>';
        html += '</div></div>';
      }

      if (state.showBookingForm) {
        const availableConsultTimes = getAvailableConsultTimes();
        const availableRoomsForBookingDate = [...new Set(state.availableSlots.filter(s => s.date === state.bookingForm.date).map(s => s.room))].sort();
        
        html += '<div class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4" onclick="if(event.target.classList.contains(\'bg-opacity-75\')) { state.showBookingForm = false; state.editingBooking = null; render(); }">';
        html += '<div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 md:p-8 transform transition-all scale-100">';
        html += '<h3 class="text-2xl font-bold text-gray-800 mb-6">' + (state.editingBooking ? '✏️ 상담 예약 수정' : '➕ 상담 예약 등록') + ' (' + state.bookingForm.date + ')</h3>';
        
        html += '<div class="space-y-4">';

        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">학생 이름</label>';
        html += '<input type="text" value="' + state.bookingForm.studentName + '" oninput="state.bookingForm.studentName = this.value;" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required placeholder="학생 이름"></div>';
        
        html += '<div class="flex gap-4">';
        html += '<div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">학교</label>';
        html += '<input type="text" value="' + state.bookingForm.school + '" oninput="state.bookingForm.school = this.value;" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="학교명 (모를 경우 \'모름\')"></div>';

        html += '<div class="w-1/3"><label class="block text-sm font-medium text-gray-700 mb-1">학년</label>';
        html += '<select onchange="state.bookingForm.grade = this.value; state.bookingForm.time = \'\'; render();" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>';
        ['elementary1','elementary2','elementary3','elementary4','elementary5','elementary6', 'middle1','middle2','middle3','high1','high2','high3','unknown'].forEach(g => {
          html += '<option value="' + g + '" ' + (state.bookingForm.grade === g ? 'selected' : '') + '>' + gradeLabels[g] + '</option>';
        });
        html += '</select></div></div>';
        
        html += '<div class="flex items-center"><input id="hasLevelTest" type="checkbox" ' + (state.bookingForm.hasLevelTest ? 'checked' : '') + ' onchange="state.bookingForm.hasLevelTest = this.checked; state.bookingForm.time = \'\'; render();" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">';
        html += '<label for="hasLevelTest" class="ml-2 block text-sm text-gray-900">레벨테스트 병행 (초등 40분, 중/고등 50분 추가)</label></div>';
        
        if (state.bookingForm.hasLevelTest && state.bookingForm.grade === 'unknown') {
          html += '<div class="text-sm text-red-600 p-3 bg-red-50 rounded-lg border border-red-200">⚠️ 학년을 모르는 경우 레벨테스트 시간을 정확히 계산할 수 없습니다. 학년을 선택하거나 레벨테스트 옵션을 해제해주세요.</div>';
        }
        
        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">상담실</label>';
        html += '<select onchange="state.bookingForm.room = this.value; state.bookingForm.time = \'\'; render();" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>';
        html += '<option value="">선택</option>';
        availableRoomsForBookingDate.forEach(room => {
          html += '<option value="' + room + '" ' + (state.bookingForm.room === room ? 'selected' : '') + '>' + room + '</option>';
        });
        html += '</select></div>';
        
        html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">' + (state.bookingForm.hasLevelTest ? '레벨테스트 시작 시간' : '상담 시작 시간') + ' (30분 소요)</label>';
        if (state.bookingForm.room && availableConsultTimes.length > 0) {
          html += '<select onchange="state.bookingForm.time = this.value; render();" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>';
          html += '<option value="">시간 선택</option>';
          availableConsultTimes.forEach(time => {
            const label = state.bookingForm.hasLevelTest ? time + ' (레테 시작)' : time + ' (상담 시작)';
            html += '<option value="' + time + '" ' + (state.bookingForm.time === time ? 'selected' : '') + '>' + label + '</option>';
          });
          html += '</select>';
        } else if (!state.bookingForm.room) {
          html += '<p class="text-sm text-red-500 p-3 bg-red-50 rounded-lg">상담실을 먼저 선택해주세요.</p>';
        } else {
          html += '<p class="text-sm text-red-500 p-3 bg-red-50 rounded-lg">선택된 날짜/상담실에 예약 가능한 시간이 없습니다.</p>';
        }
        html += '</div>';
        
        if (state.bookingForm.time) {
          const g = String(state.bookingForm.grade || '').trim();
          const isElementary = g.startsWith('elementary') || g === 'elementary' ||
                               ['초','초1','초2','초3','초4','초5','초6'].some(k => g.includes(k));
          const levelTestMins = state.bookingForm.hasLevelTest ? (isElementary ? 40 : 50) : 0;
          
          if (state.bookingForm.hasLevelTest) {
            const consultStartTime = addMinutesToTime(state.bookingForm.time, levelTestMins);
            const consultEndTime = addMinutesToTime(consultStartTime, 30);
            html += '<div class="text-sm text-blue-700 p-3 bg-blue-100 rounded-lg">';
            html += '레벨테스트 시간: ' + state.bookingForm.time + ' - ' + consultStartTime + '<br>';
            html += '상담 시간: ' + consultStartTime + ' - ' + consultEndTime + '<br>';
            html += '<strong>총 예약 시간: ' + state.bookingForm.time + ' - ' + consultEndTime + ' (' + (levelTestMins + 30) + '분)</strong>';
            html += '</div>';
          } else {
            const consultEndTime = addMinutesToTime(state.bookingForm.time, 30);
            html += '<div class="text-sm text-blue-700 p-3 bg-blue-100 rounded-lg">';
            html += '총 예약 시간: ' + state.bookingForm.time + ' - ' + consultEndTime + ' (30분)';
            html += '</div>';
          }
        }
        
        html += '</div>';

        html += '<div class="flex justify-end gap-3 mt-8">';
        html += '<button onclick="state.showBookingForm = false; state.editingBooking = null; render();" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition shadow-md">취소</button>';
        html += '<button onclick="addBooking()" ' + (state.syncing ? 'disabled' : '') + ' class="px-4 py-2 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition disabled:opacity-50 shadow-md">' + (state.editingBooking ? '수정 완료' : '예약 등록') + '</button>';
        html += '</div>';
        html += '</div></div>';
      }

      if (state.showReasonModal) {
        const reasonOptions = [
          { value: '입력 오류', label: '잘못 입력된 예약' },
          { value: '학생 불참', label: '학생 불참 (노쇼)' },
          { value: '예약 취소', label: '사전 예약 취소' },
          { value: '기타', label: '기타 (직접 입력)' }
        ];
        
        html += '<div class="fixed inset-0
