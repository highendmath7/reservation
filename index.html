<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>상담 예약 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { font-family: 'Malgun Gothic', sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
  <div id="app" class="max-w-7xl mx-auto"></div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxUJiREPjy8kf6ZiIwmd4cf0rT7wRXoZRESaFgkwMbjg8HQmP8A5YlJ7azI79FeOfq0Ww/exec';
    
    let state = {
      availableSlots: [],
      bookings: [],
      showSlotForm: false,
      showBookingForm: false,
      showHistoryModal: false,
      showReasonModal: false,
      editingSlot: null,
      currentDate: new Date(),
      selectedDate: null,
      loading: false,
      syncing: false,
      selectedBookingId: null,
      cancelReason: '',
      slotForm: {
        date: '',
        startTime: '',
        endTime: '',
        room: ''
      },
      bookingForm: {
        studentName: '',
        school: '',
        grade: 'elementary',
        hasLevelTest: false,
        date: '',
        time: '',
        room: ''
      }
    };

    const gradeLabels = {
      elementary: '초등',
      middle: '중등',
      high: '고등'
    };

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function getOneMonthAgo() {
      const date = new Date();
      date.setMonth(date.getMonth() - 1);
      return formatDate(date);
    }

    async function loadFromGoogleSheets() {
      state.loading = true;
      render();
      
      try {
        const today = formatDate(new Date());
        const oneMonthAgo = getOneMonthAgo();
        
        const slotsResponse = await fetch(GOOGLE_SCRIPT_URL + '?sheet=slots');
        const slotsData = await slotsResponse.json();
        state.availableSlots = slotsData.filter(slot => slot.date >= oneMonthAgo && slot.id);
        
        const bookingsResponse = await fetch(GOOGLE_SCRIPT_URL + '?sheet=bookings');
        const bookingsData = await bookingsResponse.json();
        state.bookings = bookingsData.filter(booking => booking.date >= oneMonthAgo && booking.id);
        
        await cleanupOldData(oneMonthAgo);
        
        console.log('데이터 로드 완료');
      } catch (error) {
        console.error('데이터 로드 실패:', error);
        alert('데이터를 불러오는데 실패했습니다.');
      } finally {
        state.loading = false;
        render();
      }
    }

    async function cleanupOldData(cutoffDate) {
      try {
        const oldSlots = state.availableSlots.filter(slot => slot.date < cutoffDate);
        const oldBookings = state.bookings.filter(booking => booking.date < cutoffDate);
        
        for (let i = 0; i < oldSlots.length; i++) {
          await deleteFromGoogleSheets('slots', oldSlots[i].id);
        }
        
        for (let i = 0; i < oldBookings.length; i++) {
          await deleteFromGoogleSheets('bookings', oldBookings[i].id);
        }
        
        if (oldSlots.length > 0 || oldBookings.length > 0) {
          console.log('1달 이전 데이터 삭제 완료');
        }
      } catch (error) {
        console.error('데이터 정리 실패:', error);
      }
    }

    async function addToGoogleSheets(sheet, data) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'add');
      formData.append('data', JSON.stringify(data));
      
      await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: formData
      });
    }

    async function updateInGoogleSheets(sheet, id, data) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'update');
      formData.append('id', id);
      formData.append('data', JSON.stringify(data));
      
      await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: formData
      });
    }

    async function deleteFromGoogleSheets(sheet, id) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'delete');
      formData.append('id', id);
      
      await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: formData
      });
    }

    function timeToMins(time) {
      const parts = time.split(':');
      const h = parseInt(parts[0]);
      const m = parseInt(parts[1]);
      return h * 60 + m;
    }

    function minsToTime(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    }

    function addMinutesToTime(time, minutes) {
      const totalMins = timeToMins(time) + minutes;
      return minsToTime(totalMins);
    }

    async function addSlot() {
      if (!state.slotForm.date || !state.slotForm.startTime || !state.slotForm.endTime || !state.slotForm.room) {
        alert('모든 필드를 입력해주세요.');
        return;
      }
      
      state.syncing = true;
      render();
      
      try {
        const newSlot = {
          id: Date.now().toString(),
          date: state.slotForm.date,
          startTime: state.slotForm.startTime,
          endTime: state.slotForm.endTime,
          room: state.slotForm.room
        };
        await addToGoogleSheets('slots', newSlot);
        state.availableSlots.push(newSlot);
        
        state.slotForm = { date: '', startTime: '', endTime: '', room: '' };
        state.showSlotForm = false;
        alert('저장되었습니다!');
      } catch (error) {
        console.error('에러:', error);
        alert('저장 실패!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    async function addBooking() {
      if (!state.bookingForm.studentName || !state.bookingForm.date || 
          !state.bookingForm.time || !state.bookingForm.room) {
        alert('모든 필드를 입력해주세요.');
        return;
      }
      
      let levelTestMins = 0;
      if (state.bookingForm.hasLevelTest) {
        levelTestMins = state.bookingForm.grade === 'elementary' ? 40 : 50;
      }
      
      const startTime = addMinutesToTime(state.bookingForm.time, -levelTestMins);
      const endTime = addMinutesToTime(state.bookingForm.time, 30);
      
      const hasConflict = state.bookings.some(booking => {
        if (booking.date !== state.bookingForm.date || booking.room !== state.bookingForm.room) return false;
        const existingStart = timeToMins(booking.time);
        const existingEnd = timeToMins(booking.endTime);
        const newStart = timeToMins(startTime);
        const newEnd = timeToMins(endTime);
        return !(newEnd <= existingStart || newStart >= existingEnd);
      });
      
      if (hasConflict) {
        alert('선택한 시간에 다른 예약과 겹칩니다.');
        return;
      }
      
      state.syncing = true;
      render();
      
      try {
        const newBooking = {
          id: Date.now().toString(),
          studentName: state.bookingForm.studentName,
          school: state.bookingForm.school,
          grade: state.bookingForm.grade,
          hasLevelTest: state.bookingForm.hasLevelTest,
          date: state.bookingForm.date,
          time: startTime,
          endTime: endTime,
          room: state.bookingForm.room,
          consultTime: state.bookingForm.time,
          status: 'scheduled'
        };
        
        await addToGoogleSheets('bookings', newBooking);
        state.bookings.push(newBooking);
        
        state.bookingForm = {
          studentName: '',
          school: '',
          grade: 'elementary',
          hasLevelTest: false,
          date: state.bookingForm.date,
          time: '',
          room: ''
        };
        state.showBookingForm = false;
        alert('예약이 등록되었습니다!');
      } catch (error) {
        console.error('에러:', error);
        alert('예약 등록 실패!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    async function updateBookingStatus(id, status, reason = '') {
      state.syncing = true;
      render();
      
      try {
        const booking = state.bookings.find(b => b.id === id);
        if (!booking) return;
        
        const updatedBooking = {
          ...booking,
          status: status,
          cancelReason: reason || '',
          completedAt: status === 'completed' ? new Date().toISOString() : booking.completedAt
        };
        
        await updateInGoogleSheets('bookings', id, updatedBooking);
        
        const index = state.bookings.findIndex(b => b.id === id);
        state.bookings[index] = updatedBooking;
        
        alert(status === 'completed' ? '완료 처리되었습니다!' : '미진행 처리되었습니다!');
      } catch (error) {
        console.error('에러:', error);
        alert('상태 변경 실패!');
      } finally {
        state.syncing = false;
        state.showReasonModal = false;
        state.selectedBookingId = null;
        state.cancelReason = '';
        render();
      }
    }

    function openReasonModal(id) {
      state.selectedBookingId = id;
      state.showReasonModal = true;
      state.cancelReason = '';
      render();
    }

    async function deleteSlot(id) {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      
      state.syncing = true;
      render();
      
      try {
        await deleteFromGoogleSheets('slots', id);
        state.availableSlots = state.availableSlots.filter(s => s.id !== id);
        alert('삭제되었습니다!');
      } catch (error) {
        alert('삭제 실패!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    async function deleteBooking(id) {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      
      state.syncing = true;
      render();
      
      try {
        await deleteFromGoogleSheets('bookings', id);
        state.bookings = state.bookings.filter(b => b.id !== id);
        alert('삭제되었습니다!');
      } catch (error) {
        alert('삭제 실패!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    function renderCalendar() {
      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      const today = formatDate(new Date());
      const oneMonthAgo = getOneMonthAgo();
      
      let html = '';
      
      for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="h-20"></div>';
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = formatDate(date);
        const hasSlots = state.availableSlots.some(slot => slot.date === dateStr);
        const hasBooking = state.bookings.some(booking => booking.date === dateStr);
        const isSelected = state.selectedDate === dateStr;
        const isToday = dateStr === today;
        const isPast = dateStr < today;
        const isTooOld = dateStr < oneMonthAgo;
        
        let classes = 'h-20 border p-2 transition ';
        if (isTooOld || isPast) {
          classes += 'bg-gray-100 cursor-pointer opacity-50';
        } else if (isSelected) {
          classes += 'bg-indigo-100 border-indigo-500 cursor-pointer';
        } else if (hasSlots || hasBooking) {
          classes += 'bg-green-50 hover:bg-green-100 cursor-pointer';
        } else {
          classes += 'bg-gray-50 cursor-pointer';
        }
        if (isToday) classes += ' ring-2 ring-blue-400';
        
        html += '<div class="' + classes + '" onclick="handleDateClick(\'' + dateStr + '\', ' + (isPast && !isTooOld) + ')">';
        html += '<div class="font-semibold ' + (isPast ? 'text-gray-400' : 'text-gray-700') + '">' + day + '</div>';
        html += '<div class="flex gap-1 mt-1">';
        if (hasSlots) {
          html += '<div class="w-2 h-2 bg-green-500 rounded-full"></div>';
        }
        if (hasBooking) {
          html += '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>';
        }
        html += '</div></div>';
      }
      
      return html;
    }

    function handleDateClick(dateStr, isPast) {
      state.selectedDate = dateStr;
      if (!isPast) {
        state.bookingForm.date = dateStr;
      }
      render();
    }

    function generateTimeOptions() {
      const options = [];
      for (let h = 10; h <= 22; h++) {
        for (let m = 0; m < 60; m += 5) {
          const time = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
          options.push(time);
        }
      }
      return options;
    }
    
    function getAvailableConsultTimes() {
      if (!state.bookingForm.date || !state.bookingForm.room) return [];
      
      const slots = state.availableSlots.filter(s => 
        s.date === state.bookingForm.date && s.room === state.bookingForm.room
      );
      
      if (slots.length === 0) return [];
      
      const availableTimes = [];
      const allBookings = state.bookings.filter(b => 
        b.date === state.bookingForm.date && b.room === state.bookingForm.room
      );
      
      for (let i = 0; i < slots.length; i++) {
        const slot = slots[i];
        const startMins = timeToMins(slot.startTime);
        const endMins = timeToMins(slot.endTime);
        
        let levelTestMins = 0;
        if (state.bookingForm.hasLevelTest) {
          levelTestMins = state.bookingForm.grade === 'elementary' ? 40 : 50;
        }
        
        for (let mins = startMins; mins < endMins; mins += 5) {
          const consultTime = minsToTime(mins);
          const testStartTime = minsToTime(mins - levelTestMins);
          const consultEndTime = minsToTime(mins + 30);
          
          if (mins - levelTestMins < startMins || mins + 30 > endMins) continue;
          
          let hasConflict = false;
          for (let j = 0; j < allBookings.length; j++) {
            const booking = allBookings[j];
            const bookingStart = timeToMins(booking.time);
            const bookingEnd = timeToMins(booking.endTime);
            const newStart = mins - levelTestMins;
            const newEnd = mins + 30;
            
            if (!(newEnd <= bookingStart || newStart >= bookingEnd)) {
              hasConflict = true;
              break;
            }
          }
          
          if (!hasConflict) {
            availableTimes.push(consultTime);
          }
        }
      }
      
      return availableTimes;
    }

    function render() {
      const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
      const selectedSlots = state.availableSlots.filter(s => s.date === state.selectedDate);
      const selectedBookings = state.bookings.filter(b => b.date === state.selectedDate).sort((a, b) => a.time.localeCompare(b.time));
      const availableRooms = [...new Set(state.availableSlots.filter(s => s.date === state.bookingForm.date).map(s => s.room))];
      const today = formatDate(new Date());
      const todayBookings = state.bookings.filter(b => b.date === today).sort((a, b) => a.time.localeCompare(b.time));
      
      let html = '<div class="bg-white rounded-2xl shadow-xl p-8">';
      html += '<div class="flex justify-between items-center mb-8">';
      html += '<h1 class="text-3xl font-bold text-gray-800">📅 상담 예약 시스템</h1>';
      html += '<div class="flex gap-2">';
      html += '<button onclick="state.showHistoryModal = true; render();" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">📋 지난 내역</button>';
      html += '<button onclick="loadFromGoogleSheets()" ' + (state.loading || state.syncing ? 'disabled' : '') + ' class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition disabled:opacity-50">';
      html += '🔄 ' + (state.loading ? '로딩중...' : state.syncing ? '동기화중...' : '새로고침');
      html += '</button></div></div>';

      if (state.loading) {
        html += '<div class="text-center py-20">';
        html += '<div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>';
        html += '<p class="mt-4 text-gray-600">데이터를 불러오는 중...</p>';
        html += '</div>';
      } else {
        // 오늘의 상담 예약
        html += '<div class="mb-8 bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200">';
        html += '<h2 class="text-2xl font-bold text-gray-800 mb-4">📍 오늘의 상담 예약 (' + today + ')</h2>';
        
        if (todayBookings.length === 0) {
          html += '<p class="text-gray-500 text-center py-8">오늘 예약된 상담이 없습니다.</p>';
        } else {
          html += '<div class="space-y-3">';
          for (let i = 0; i < todayBookings.length; i++) {
            const booking = todayBookings[i];
            const statusColor = booking.status === 'completed' ? 'bg-green-100 border-green-300' : 
                               booking.status === 'cancelled' ? 'bg-red-100 border-red-300' : 
                               'bg-white border-blue-300';
            
            html += '<div class="' + statusColor + ' border-2 p-4 rounded-lg">';
            html += '<div class="flex justify-between items-start">';
            html += '<div class="flex-1">';
            html += '<div class="text-lg font-semibold text-gray-800 mb-2">';
            html += '<span class="text-indigo-600">' + booking.room + '</span> | ';
            html += booking.school + ' ' + gradeLabels[booking.grade] + ' | ';
            html += '<span class="text-blue-700">' + booking.studentName + '</span>';
            if (booking.status === 'completed') {
              html += ' <span class="text-green-600 text-sm">✓ 완료</span>';
            } else if (booking.status === 'cancelled') {
              html += ' <span class="text-red-600 text-sm">✗ 미진행</span>';
            }
            html += '</div>';
            html += '<div class="flex items-center gap-4 text-gray-600">';
            html += '<span class="font-medium">🕐 ' + booking.time + ' - ' + booking.endTime + '</span>';
            html += '<span class="text-indigo-600 font-medium">' + (booking.hasLevelTest ? '레벨테스트 + 상담' : '상담') + '</span>';
            html += '</div>';
            if (booking.hasLevelTest) {
              html += '<p class="text-sm text-gray-500 mt-1">레벨테스트: ' + booking.time + ' / 상담: ' + booking.consultTime + '</p>';
            }
            if (booking.status === 'cancelled' && booking.cancelReason) {
              html += '<p class="text-sm text-red-600 mt-2 bg-red-50 p-2 rounded">미진행 사유: ' + booking.cancelReason + '</p>';
            }
            html += '</div>';
            
            if (booking.status === 'scheduled') {
              html += '<div class="flex gap-2 ml-4">';
              html += '<button onclick="updateBookingStatus(\'' + booking.id + '\', \'completed\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:opacity-50">✓ 완료</button>';
              html += '<button onclick="openReasonModal(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 disabled:opacity-50">✗ 미진행</button>';
              html += '</div>';
            }
            
            html += '</div></div>';
          }
          html += '</div>';
        }
        html += '</div>';

        html += '<div class="mb-8">';
        html += '<div class="flex justify-between items-center mb-4">';
        html += '<h2 class="text-xl font-semibold text-gray-700">캘린더</h2>';
        html += '<div class="flex items-center gap-4">';
        html += '<button onclick="prevMonth()" class="p-2 hover:bg-gray-100 rounded">◀</button>';
        html += '<span class="text-lg font-semibold">' + state.currentDate.getFullYear() + '년 ' + monthNames[state.currentDate.getMonth()] + '</span>';
        html += '<button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded">▶</button>';
        html += '</div></div>';
        
        html += '<div class="mb-2 flex gap-4 text-sm text-gray-600">';
        html += '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-green-500 rounded-full"></div><span>상담 가능</span></div>';
        html += '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-blue-500 rounded-full"></div><span>예약 있음</span></div>';
        html += '</div>';

        html += '<div class="grid grid-cols-7 gap-1 mb-2">';
        const days = ['일', '월', '화', '수', '목', '금', '토'];
        for (let i = 0; i < days.length; i++) {
          html += '<div class="text-center font-semibold text-gray-600 p-2">' + days[i] + '</div>';
        }
        html += '</div>';
        
        html += '<div class="grid grid-cols-7 gap-1">';
        html += renderCalendar();
        html += '</div></div>';

        if (state.selectedDate) {
          const isPastDate = state.selectedDate < today;
          html += '<div class="mb-8 space-y-6">';
          html += '<div><div class="flex justify-between items-center mb-3">';
          html += '<h3 class="font-semibold text-gray-800">' + state.selectedDate + ' 상담 가능 시간</h3>';
          if (!isPastDate) {
            html += '<button onclick="state.slotForm.date = \'' + state.selectedDate + '\'; state.showSlotForm = true; render();" class="bg-indigo-500 text-white px-3 py-1 rounded text-sm hover:bg-indigo-600">+ 시간 추가</button>';
          }
          html += '</div><div class="grid grid-cols-1 md:grid-cols-2 gap-3">';
          
          if (selectedSlots.length === 0) {
            html += '<p class="text-gray-500 text-sm">가능 시간 없음</p>';
          } else {
            for (let i = 0; i < selectedSlots.length; i++) {
              const slot = selectedSlots[i];
              html += '<div class="bg-green-50 p-3 rounded border border-green-200">';
              html += '<div class="flex justify-between items-start">';
              html += '<div><div class="font-medium text-green-700">' + slot.room + '</div>';
              html += '<div class="text-sm text-gray-600">' + slot.startTime + ' - ' + slot.endTime + '</div></div>';
              if (!isPastDate) {
                html += '<button onclick="deleteSlot(\'' + slot.id + '\')" class="text-red-500 hover:text-red-700 text-sm">삭제</button>';
              }
              html += '</div></div>';
            }
          }
          html += '</div></div>';

          html += '<div><h3 class="font-semibold text-gray-800 mb-3">' + state.selectedDate + ' 예약 현황</h3>';
          html += '<div class="space-y-2">';
          
          if (selectedBookings.length === 0) {
            html += '<p class="text-gray-500 text-sm">예약 없음</p>';
          } else {
            for (let i = 0; i < selectedBookings.length; i++) {
              const booking = selectedBookings[i];
              const statusColor = booking.status === 'completed' ? 'bg-green-50 border-green-200' : 
                                 booking.status === 'cancelled' ? 'bg-red-50 border-red-200' : 
                                 'bg-blue-50 border-blue-200';
              
              html += '<div class="' + statusColor + ' p-3 rounded border">';
              html += '<div class="flex justify-between items-start"><div class="flex-1">';
              html += '<div class="text-sm"><span class="font-medium text-blue-700">' + booking.room + '</span>';
              html += '<span class="text-gray-600"> | </span>';
              html += '<span class="text-gray-700">' + booking.school + ' ' + gradeLabels[booking.grade] + '</span>';
              html += '<span class="text-gray-600"> | </span>';
              html += '<span class="font-medium">' + booking.studentName + '</span>';
              if (booking.status === 'completed') {
                html += ' <span class="text-green-600">✓</span>';
              } else if (booking.status === 'cancelled') {
                html += ' <span class="text-red-600">✗</span>';
              }
              html += '</div>';
              html += '<div class="text-sm text-gray-600 mt-1">';
              html += '<span>' + booking.time + ' - ' + booking.endTime + '</span>';
              html += '<span class="text-gray-600"> | </span>';
              html += '<span class="text-indigo-600 font-medium">' + (booking.hasLevelTest ? '레벨테스트 + 상담' : '상담') + '</span>';
