<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상담 예약 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap');
        * { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto"></div>

    <script>
        // 🚨 수정됨: 고객님이 제공한 최신 URL로 교체
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxgfYgNWAM83yOeYTNnlSZWWMymS3uTxWf7mIhIw5ixRQjrUlr02O8fTDUg9EXe7v3fTw/exec';

        let state = {
            availableSlots: [],
            bookings: [],
            showSlotForm: false,
            showBookingForm: false,
            editingSlot: null,
            currentDate: new Date(),
            selectedDate: formatDate(new Date()), // 오늘 날짜를 기본 선택 날짜로 설정
            loading: false,
            syncing: false,
            slotForm: {
                date: formatDate(new Date()),
                startTime: '',
                endTime: '',
                room: ''
            },
            bookingForm: {
                studentName: '',
                school: '',
                grade: 'elementary',
                hasLevelTest: false,
                date: formatDate(new Date()),
                time: '', // This is the consultation START time
                room: ''
            },
            // Custom Message/Confirmation Modal State
            message: {
                show: false,
                text: '',
                isConfirm: false,
                confirmAction: null,
            }
        };

        const gradeLabels = {
            elementary: '초등',
            middle: '중등',
            high: '고등'
        };

        // --- Utility Functions ---

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        function timeToMins(time) {
            // 시간 문자열이 "HH:MM:SS" 또는 "HH:MM" 형태여야 합니다.
            const cleanTime = time.substring(0, 5);
            const parts = cleanTime.split(':');
            const h = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10);
            return h * 60 + m;
        }

        function minsToTime(mins) {
            const totalMins = (mins % (24 * 60) + (24 * 60)) % (24 * 60); // Ensure positive and within 24h
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
        }

        function addMinutesToTime(time, minutes) {
            const totalMins = timeToMins(time) + minutes;
            return minsToTime(totalMins);
        }
        
        function generateTimeOptions(interval = 5) {
            const options = [];
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += interval) {
                    const time = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
                    options.push(time);
                }
            }
            return options;
        }

        /**
         * 예약 폼의 시간 드롭다운 옵션을 필터링합니다.
         */
        function generateFilteredTimeOptions(interval = 5) {
            const { date, room, grade, hasLevelTest } = state.bookingForm;
            if (!date || !room) return [];

            const consultDurationMins = 30;
            const levelTestMins = hasLevelTest ? (grade === 'elementary' ? 40 : 50) : 0;
            
            const allOptions = generateTimeOptions(interval);
            const relevantSlots = state.availableSlots.filter(s => s.date === date && s.room === room);
            const existingBookings = state.bookings.filter(b => b.date === date && b.room === room);

            const filteredOptions = [];

            for (const consultTime of allOptions) {
                // 1. 예약 점유 시간 계산 (Test Start Time to Consultation End Time)
                const bookingStartTime = addMinutesToTime(consultTime, -levelTestMins); // Test Start Time
                const bookingEndTime = addMinutesToTime(consultTime, consultDurationMins); // Consultation End Time

                const newStartMins = timeToMins(bookingStartTime);
                const newEndMins = timeToMins(bookingEndTime);

                // 2. 가용 슬롯에 완전히 포함되는지 확인
                let slotFits = relevantSlots.some(slot => {
                    const slotStartMins = timeToMins(slot.startTime);
                    const slotEndMins = timeToMins(slot.endTime);
                    return newStartMins >= slotStartMins && newEndMins <= slotEndMins;
                });
                
                if (!slotFits) continue;

                // 3. 기존 예약과 겹치는지 확인
                const hasConflict = existingBookings.some(booking => {
                    const existingStartMins = timeToMins(booking.time); 
                    const existingEndMins = timeToMins(booking.endTime);
                    
                    return newStartMins < existingEndMins && newEndMins > existingStartMins;
                });

                if (!hasConflict) {
                    filteredOptions.push(consultTime);
                }
            }
            return filteredOptions;
        }


        // --- Message Box Functions ---

        function showMessage(text) {
            state.message = { show: true, text: text, isConfirm: false, confirmAction: null };
            render();
        }

        function showConfirm(text, action) {
            state.message = { show: true, text: text, isConfirm: true, confirmAction: action };
            render();
        }

        function closeMessage() {
            state.message.show = false;
            state.message.confirmAction = null;
            render();
        }

        function executeConfirmAction() {
            if (state.message.confirmAction) {
                state.message.confirmAction();
            }
            closeMessage();
        }

        // --- Google Sheets API Functions ---

        async function loadFromGoogleSheets() {
            state.loading = true;
            render();
            
            try {
                const today = formatDate(new Date());
                
                // --- Slots Load ---
                const slotsResponse = await fetch(GOOGLE_SCRIPT_URL + '?sheet=slots');
                if (!slotsResponse.ok) throw new Error('Slots fetch failed: ' + slotsResponse.status);
                const slotsData = await slotsResponse.json();
                
                if (slotsData.error) throw new Error('Slots Script Error: ' + slotsData.error);
                
                // date가 오늘 이후인 슬롯만 필터링
                state.availableSlots = slotsData.filter(slot => slot.date >= today && slot.id);
                
                // --- Bookings Load ---
                const bookingsResponse = await fetch(GOOGLE_SCRIPT_URL + '?sheet=bookings');
                if (!bookingsResponse.ok) throw new Error('Bookings fetch failed: ' + bookingsResponse.status);
                const bookingsData = await bookingsResponse.json();
                
                if (bookingsData.error) throw new Error('Bookings Script Error: ' + bookingsData.error);
                
                // date가 오늘 이후인 예약만 필터링
                state.bookings = bookingsData.filter(booking => booking.date >= today && booking.id);
                
                console.log('데이터 로드 완료');
                s된 예약이 없습니다.</p>';
                } else {
                    for (let i = 0; i < sortedBookings.length; i++) {
                        const booking = sortedBookings[i];
                        html += '<div class="bg-white border-2 border-gray-200 p-4 rounded-xl hover:shadow-lg transition">';
                        html += '<div class="flex justify-between items-center"><div class="flex-1">';
                        html += '<div class="text-lg font-semibold text-gray-800 mb-1">';
                        html += booking.date + ' / ' + booking.room + ' / ' + booking.studentName;
                        html += '</div><div class="flex items-center gap-4 text-gray-600 text-sm">';
                        html += '<span>🕐 ' + booking.time + ' - ' + booking.endTime + '</span>';
                        html += '<span class="font-medium text-indigo-600">' + (booking.hasLevelTest ? '레벨테스트 + 상담' : '상담') + '</span>';
                        html += '</div>';
                        if (booking.hasLevelTest) {
                             html += '<p class="text-xs text-gray-500 mt-1">상담 시작: ' + booking.consultTime + ' / 학교: ' + booking.school + '</p>';
                        }
                        html += '</div><button onclick="deleteBooking(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="text-red-500 hover:text-red-700 disabled:opacity-50 p-2">🗑️</button>';
                        html += '</div></div>';
                    }
                }
                html += '</div></div>';
                html += '</div>'; // End App Content
            }

            html += '</div>'; // End App container

            // Append the custom message box UI
            html += renderMessageBox();

            document.getElementById('app').innerHTML = html;
        }

        window.onload = function() {
            loadFromGoogleSheets();
        };
    </script>
</body>
</html>

