<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>상담 예약 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { font-family: 'Malgun Gothic', sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
  <div id="app" class="max-w-7xl mx-auto"></div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxZR0Thlm8VrgFXt-9gI-3kxTbHOXmXcddC_Aa5NGkI-IV-zfac9kV2BBx9oAr22odEdw/exec';
    
    let state = {
      availableSlots: [],
      bookings: [],
      showSlotForm: false,
      showBookingForm: false,
      editingSlot: null,
      currentDate: new Date(),
      selectedDate: null,
      loading: false,
      syncing: false,
      slotForm: {
        date: '',
        startTime: '',
        endTime: '',
        room: ''
      },
      bookingForm: {
        studentName: '',
        school: '',
        grade: 'elementary',
        hasLevelTest: false,
        date: '',
        time: '',
        room: ''
      }
    };

    const gradeLabels = {
      elementary: '초등',
      middle: '중등',
      high: '고등'
    };

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    async function loadFromGoogleSheets() {
      state.loading = true;
      render();
      
      try {
        const today = formatDate(new Date());
        
        const slotsResponse = await fetch(GOOGLE_SCRIPT_URL + '?sheet=slots');
        const slotsData = await slotsResponse.json();
        state.availableSlots = slotsData.filter(slot => slot.date >= today && slot.id);
        
        const bookingsResponse = await fetch(GOOGLE_SCRIPT_URL + '?sheet=bookings');
        const bookingsData = await bookingsResponse.json();
        state.bookings = bookingsData.filter(booking => booking.date >= today && booking.id);
        
        console.log('데이터 로드 완료');
      } catch (error) {
        console.error('데이터 로드 실패:', error);
        alert('데이터를 불러오는데 실패했습니다.');
      } finally {
        state.loading = false;
        render();
      }
    }

    async function addToGoogleSheets(sheet, data) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'add');
      formData.append('data', JSON.stringify(data));
      
      await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: formData
      });
    }

    async function deleteFromGoogleSheets(sheet, id) {
      const formData = new FormData();
      formData.append('sheet', sheet);
      formData.append('action', 'delete');
      formData.append('id', id);
      
      await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: formData
      });
    }

    function timeToMins(time) {
      const parts = time.split(':');
      const h = parseInt(parts[0]);
      const m = parseInt(parts[1]);
      return h * 60 + m;
    }

    function minsToTime(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    }

    function addMinutesToTime(time, minutes) {
      const totalMins = timeToMins(time) + minutes;
      return minsToTime(totalMins);
    }

    async function addSlot() {
      if (!state.slotForm.date || !state.slotForm.startTime || !state.slotForm.endTime || !state.slotForm.room) {
        alert('모든 필드를 입력해주세요.');
        return;
      }
      
      state.syncing = true;
      render();
      
      try {
        const newSlot = {
          id: Date.now().toString(),
          date: state.slotForm.date,
          startTime: state.slotForm.startTime,
          endTime: state.slotForm.endTime,
          room: state.slotForm.room
        };
        await addToGoogleSheets('slots', newSlot);
        state.availableSlots.push(newSlot);
        
        state.slotForm = { date: '', startTime: '', endTime: '', room: '' };
        state.showSlotForm = false;
        alert('저장되었습니다!');
      } catch (error) {
        console.error('에러:', error);
        alert('저장 실패!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    async function addBooking() {
      if (!state.bookingForm.studentName || !state.bookingForm.date || 
          !state.bookingForm.time || !state.bookingForm.room) {
        alert('모든 필드를 입력해주세요.');
        return;
      }
      
      let levelTestMins = 0;
      if (state.bookingForm.hasLevelTest) {
        levelTestMins = state.bookingForm.grade === 'elementary' ? 40 : 50;
      }
      
      const startTime = addMinutesToTime(state.bookingForm.time, -levelTestMins);
      const endTime = addMinutesToTime(state.bookingForm.time, 30);
      
      const hasConflict = state.bookings.some(booking => {
        if (booking.date !== state.bookingForm.date || booking.room !== state.bookingForm.room) return false;
        const existingStart = timeToMins(booking.time);
        const existingEnd = timeToMins(booking.endTime);
        const newStart = timeToMins(startTime);
        const newEnd = timeToMins(endTime);
        return !(newEnd <= existingStart || newStart >= existingEnd);
      });
      
      if (hasConflict) {
        alert('선택한 시간에 다른 예약과 겹칩니다.');
        return;
      }
      
      state.syncing = true;
      render();
      
      try {
        const newBooking = {
          id: Date.now().toString(),
          studentName: state.bookingForm.studentName,
          school: state.bookingForm.school,
          grade: state.bookingForm.grade,
          hasLevelTest: state.bookingForm.hasLevelTest,
          date: state.bookingForm.date,
          time: startTime,
          endTime: endTime,
          room: state.bookingForm.room,
          consultTime: state.bookingForm.time
        };
        
        await addToGoogleSheets('bookings', newBooking);
        state.bookings.push(newBooking);
        
        state.bookingForm = {
          studentName: '',
          school: '',
          grade: 'elementary',
          hasLevelTest: false,
          date: state.bookingForm.date,
          time: '',
          room: ''
        };
        state.showBookingForm = false;
        alert('예약이 등록되었습니다!');
      } catch (error) {
        console.error('에러:', error);
        alert('예약 등록 실패!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    async function deleteSlot(id) {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      
      state.syncing = true;
      render();
      
      try {
        await deleteFromGoogleSheets('slots', id);
        state.availableSlots = state.availableSlots.filter(s => s.id !== id);
        alert('삭제되었습니다!');
      } catch (error) {
        alert('삭제 실패!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    async function deleteBooking(id) {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      
      state.syncing = true;
      render();
      
      try {
        await deleteFromGoogleSheets('bookings', id);
        state.bookings = state.bookings.filter(b => b.id !== id);
        alert('삭제되었습니다!');
      } catch (error) {
        alert('삭제 실패!');
      } finally {
        state.syncing = false;
        render();
      }
    }

    function renderCalendar() {
      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      const today = formatDate(new Date());
      
      let html = '';
      
      for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="h-20"></div>';
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = formatDate(date);
        const hasSlots = state.availableSlots.some(slot => slot.date === dateStr);
        const hasBooking = state.bookings.some(booking => booking.date === dateStr);
        const isSelected = state.selectedDate === dateStr;
        const isToday = dateStr === today;
        const isPast = dateStr < today;
        
        let classes = 'h-20 border p-2 transition ';
        if (isPast) {
          classes += 'bg-gray-100 cursor-not-allowed opacity-50';
        } else if (isSelected) {
          classes += 'bg-indigo-100 border-indigo-500 cursor-pointer';
        } else if (hasSlots || hasBooking) {
          classes += 'bg-green-50 hover:bg-green-100 cursor-pointer';
        } else {
          classes += 'bg-gray-50 cursor-pointer';
        }
        if (isToday) classes += ' ring-2 ring-blue-400';
        
        html += '<div class="' + classes + '" onclick="handleDateClick(\'' + dateStr + '\', ' + isPast + ')">';
        html += '<div class="font-semibold ' + (isPast ? 'text-gray-400' : 'text-gray-700') + '">' + day + '</div>';
        html += '<div class="flex gap-1 mt-1">';
        if (hasSlots && !isPast) {
          html += '<div class="w-2 h-2 bg-green-500 rounded-full"></div>';
        }
        if (hasBooking && !isPast) {
          html += '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>';
        }
        html += '</div></div>';
      }
      
      return html;
    }

    function handleDateClick(dateStr, isPast) {
      if (isPast) return;
      state.selectedDate = dateStr;
      state.bookingForm.date = dateStr;
      render();
    }

    function generateTimeOptions() {
      const options = [];
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 5) {
          const time = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
          options.push(time);
        }
      }
      return options;
    }

    function render() {
      const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
      const selectedSlots = state.availableSlots.filter(s => s.date === state.selectedDate);
      const selectedBookings = state.bookings.filter(b => b.date === state.selectedDate).sort((a, b) => a.time.localeCompare(b.time));
      const availableRooms = [...new Set(state.availableSlots.filter(s => s.date === state.bookingForm.date).map(s => s.room))];
      
      let html = '<div class="bg-white rounded-2xl shadow-xl p-8">';
      html += '<div class="flex justify-between items-center mb-8">';
      html += '<h1 class="text-3xl font-bold text-gray-800">📅 상담 예약 시스템</h1>';
      html += '<button onclick="loadFromGoogleSheets()" ' + (state.loading || state.syncing ? 'disabled' : '') + ' class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition disabled:opacity-50">';
      html += '🔄 ' + (state.loading ? '로딩중...' : state.syncing ? '동기화중...' : '새로고침');
      html += '</button></div>';

      if (state.loading) {
        html += '<div class="text-center py-20">';
        html += '<div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>';
        html += '<p class="mt-4 text-gray-600">데이터를 불러오는 중...</p>';
        html += '</div>';
      } else {
        html += '<div class="mb-8">';
        html += '<div class="flex justify-between items-center mb-4">';
        html += '<h2 class="text-xl font-semibold text-gray-700">캘린더</h2>';
        html += '<div class="flex items-center gap-4">';
        html += '<button onclick="prevMonth()" class="p-2 hover:bg-gray-100 rounded">◀</button>';
        html += '<span class="text-lg font-semibold">' + state.currentDate.getFullYear() + '년 ' + monthNames[state.currentDate.getMonth()] + '</span>';
        html += '<button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded">▶</button>';
        html += '</div></div>';
        
        html += '<div class="mb-2 flex gap-4 text-sm text-gray-600">';
        html += '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-green-500 rounded-full"></div><span>상담 가능</span></div>';
        html += '<div class="flex items-center gap-2"><div class="w-3 h-3 bg-blue-500 rounded-full"></div><span>예약 있음</span></div>';
        html += '</div>';

        html += '<div class="grid grid-cols-7 gap-1 mb-2">';
        const days = ['일', '월', '화', '수', '목', '금', '토'];
        for (let i = 0; i < days.length; i++) {
          html += '<div class="text-center font-semibold text-gray-600 p-2">' + days[i] + '</div>';
        }
        html += '</div>';
        
        html += '<div class="grid grid-cols-7 gap-1">';
        html += renderCalendar();
        html += '</div></div>';

        if (state.selectedDate) {
          html += '<div class="mb-8 space-y-6">';
          html += '<div><div class="flex justify-between items-center mb-3">';
          html += '<h3 class="font-semibold text-gray-800">' + state.selectedDate + ' 상담 가능 시간</h3>';
          html += '<button onclick="state.slotForm.date = \'' + state.selectedDate + '\'; state.showSlotForm = true; render();" class="bg-indigo-500 text-white px-3 py-1 rounded text-sm hover:bg-indigo-600">+ 시간 추가</button>';
          html += '</div><div class="grid grid-cols-1 md:grid-cols-2 gap-3">';
          
          if (selectedSlots.length === 0) {
            html += '<p class="text-gray-500 text-sm">가능 시간 없음</p>';
          } else {
            for (let i = 0; i < selectedSlots.length; i++) {
              const slot = selectedSlots[i];
              html += '<div class="bg-green-50 p-3 rounded border border-green-200">';
              html += '<div class="flex justify-between items-start">';
              html += '<div><div class="font-medium text-green-700">' + slot.room + '</div>';
              html += '<div class="text-sm text-gray-600">' + slot.startTime + ' - ' + slot.endTime + '</div></div>';
              html += '<button onclick="deleteSlot(\'' + slot.id + '\')" class="text-red-500 hover:text-red-700 text-sm">삭제</button>';
              html += '</div></div>';
            }
          }
          html += '</div></div>';

          html += '<div><h3 class="font-semibold text-gray-800 mb-3">' + state.selectedDate + ' 예약 현황</h3>';
          html += '<div class="space-y-2">';
          
          if (selectedBookings.length === 0) {
            html += '<p class="text-gray-500 text-sm">예약 없음</p>';
          } else {
            for (let i = 0; i < selectedBookings.length; i++) {
              const booking = selectedBookings[i];
              html += '<div class="bg-blue-50 p-3 rounded border border-blue-200">';
              html += '<div class="flex justify-between items-start"><div class="flex-1">';
              html += '<div class="text-sm"><span class="font-medium text-blue-700">' + booking.room + '</span>';
              html += '<span class="text-gray-600"> | </span>';
              html += '<span class="text-gray-700">' + booking.school + ' ' + gradeLabels[booking.grade] + '</span>';
              html += '<span class="text-gray-600"> | </span>';
              html += '<span class="font-medium">' + booking.studentName + '</span></div>';
              html += '<div class="text-sm text-gray-600 mt-1">';
              html += '<span>' + booking.time + ' - ' + booking.endTime + '</span>';
              html += '<span class="text-gray-600"> | </span>';
              html += '<span class="text-indigo-600 font-medium">' + (booking.hasLevelTest ? '레벨테스트 + 상담' : '상담') + '</span>';
              html += '</div>';
              if (booking.hasLevelTest) {
                html += '<p class="text-xs text-gray-500 mt-1">레벨테스트: ' + booking.time + ' / 상담: ' + booking.consultTime + '</p>';
              }
              html += '</div><button onclick="deleteBooking(\'' + booking.id + '\')" class="text-red-500 hover:text-red-700 ml-2">🗑️</button>';
              html += '</div></div>';
            }
          }
          html += '</div></div></div>';
        }

        if (state.showSlotForm) {
          html += '<div class="mb-8 bg-gray-50 p-4 rounded-lg border-2 border-indigo-300">';
          html += '<h3 class="font-semibold text-gray-800 mb-3">가능 시간 추가</h3>';
          html += '<div class="grid grid-cols-4 gap-4 mb-3">';
          html += '<input type="date" value="' + state.slotForm.date + '" onchange="state.slotForm.date = this.value; render();" class="border rounded px-3 py-2" />';
          html += '<input type="time" value="' + state.slotForm.startTime + '" oninput="state.slotForm.startTime = this.value;" placeholder="시작 시간" class="border rounded px-3 py-2" />';
          html += '<input type="time" value="' + state.slotForm.endTime + '" oninput="state.slotForm.endTime = this.value;" placeholder="종료 시간" class="border rounded px-3 py-2" />';
          html += '<input type="text" value="' + state.slotForm.room + '" oninput="state.slotForm.room = this.value;" placeholder="강의실 (예: 2관)" class="border rounded px-3 py-2" />';
          html += '</div><div class="flex gap-2">';
          html += '<button onclick="addSlot()" ' + (state.syncing ? 'disabled' : '') + ' class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 disabled:opacity-50">';
          html += (state.syncing ? '저장중...' : '추가') + '</button>';
          html += '<button onclick="state.showSlotForm = false; state.slotForm = {date: \'\', startTime: \'\', endTime: \'\', room: \'\'}; render();" ' + (state.syncing ? 'disabled' : '') + ' class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 disabled:opacity-50">취소</button>';
          html += '</div></div>';
        }

        html += '<div><div class="flex justify-between items-center mb-4">';
        html += '<h2 class="text-xl font-semibold text-gray-700">예약 등록</h2>';
        html += '<button onclick="state.showBookingForm = !state.showBookingForm; render();" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600">+ 예약 추가</button>';
        html += '</div>';

        if (state.showBookingForm) {
          html += '<div class="bg-gray-50 p-4 rounded-lg mb-4 border-2 border-indigo-300">';
          html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-3">';
          html += '<input type="text" value="' + state.bookingForm.studentName + '" oninput="state.bookingForm.studentName = this.value" placeholder="학생 이름" class="border rounded px-3 py-2" />';
          html += '<input type="text" value="' + state.bookingForm.school + '" oninput="state.bookingForm.school = this.value" placeholder="학교명" class="border rounded px-3 py-2" />';
          html += '<select value="' + state.bookingForm.grade + '" onchange="state.bookingForm.grade = this.value; render();" class="border rounded px-3 py-2">';
          html += '<option value="elementary">초등학생</option><option value="middle">중학생</option><option value="high">고등학생</option></select>';
          html += '<label class="flex items-center gap-2 border rounded px-3 py-2 bg-white">';
          html += '<input type="checkbox" ' + (state.bookingForm.hasLevelTest ? 'checked' : '') + ' onchange="state.bookingForm.hasLevelTest = this.checked; render();" class="w-4 h-4" />레벨테스트</label>';
          html += '<input type="date" value="' + state.bookingForm.date + '" onchange="state.bookingForm.date = this.value; state.bookingForm.room = \'\'; state.bookingForm.time = \'\'; state.selectedDate = this.value; render();" class="border rounded px-3 py-2" />';
          html += '<select value="' + state.bookingForm.room + '" onchange="state.bookingForm.room = this.value; state.bookingForm.time = \'\'; render();" class="border rounded px-3 py-2" ' + (!state.bookingForm.date ? 'disabled' : '') + '>';
          html += '<option value="">강의실 선택</option>';
          for (let i = 0; i < availableRooms.length; i++) {
            html += '<option value="' + availableRooms[i] + '">' + availableRooms[i] + '</option>';
          }
          html += '</select>';
          html += '<select value="' + state.bookingForm.time + '" onchange="state.bookingForm.time = this.value" class="border rounded px-3 py-2" ' + (!state.bookingForm.room ? 'disabled' : '') + '>';
          html += '<option value="">상담 시작 시간</option>';
          const times = generateTimeOptions();
          for (let i = 0; i < times.length; i++) {
            html += '<option value="' + times[i] + '">' + times[i] + '</option>';
          }
          html += '</select></div><div class="flex gap-2">';
          html += '<button onclick="addBooking()" ' + (state.syncing ? 'disabled' : '') + ' class="bg-indigo-500 text-white px-6 py-2 rounded hover:bg-indigo-600 disabled:opacity-50">';
          html += (state.syncing ? '저장중...' : '예약 추가') + '</button>';
          html += '<button onclick="state.showBookingForm = false; state.bookingForm = {studentName: \'\', school: \'\', grade: \'elementary\', hasLevelTest: false, date: \'\', time: \'\', room: \'\'}; render();" ' + (state.syncing ? 'disabled' : '') + ' class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500 disabled:opacity-50">취소</button>';
          html += '</div></div>';
        }

        html += '<div class="space-y-3">';
        const sortedBookings = state.bookings.sort((a, b) => {
          if (a.date !== b.date) return a.date.localeCompare(b.date);
          return a.time.localeCompare(b.time);
        });
        for (let i = 0; i < sortedBookings.length; i++) {
          const booking = sortedBookings[i];
          html += '<div class="bg-white border-2 border-gray-200 p-4 rounded-lg hover:shadow-md transition">';
          html += '<div class="flex justify-between items-start"><div class="flex-1">';
          html += '<div class="text-lg font-semibold text-gray-800 mb-2">';
          html += booking.room + ' / ' + booking.school + ' ' + gradeLabels[booking.grade] + ' / ' + booking.studentName + ' / ' + (booking.hasLevelTest ? '레벨테스트 + 상담' : '상담');
          html += '</div><div class="flex items-center gap-4 text-gray-600">';
          html += '<span>📅 ' + booking.date + '</span>';
          html += '<span>🕐 ' + booking.time + ' - ' + booking.endTime + '</span>';
          html += '</div>';
          if (booking.hasLevelTest) {
            html += '<p class="text-sm text-gray-500 mt-1">레벨테스트: ' + booking.time + ' / 상담: ' + booking.consultTime + '</p>';
          }
          html += '</div><button onclick="deleteBooking(\'' + booking.id + '\')" ' + (state.syncing ? 'disabled' : '') + ' class="text-red-500 hover:text-red-700 disabled:opacity-50">🗑️</button>';
          html += '</div></div>';
        }
        html += '</div></div>';
      }

      html += '</div>';
      document.getElementById('app').innerHTML = html;
    }

    function prevMonth() {
      state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() - 1);
      render();
    }

    function nextMonth() {
      state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1);
      render();
    }

    window.onload = function() {
      loadFromGoogleSheets();
    };
  </script>
</body>
</html>
